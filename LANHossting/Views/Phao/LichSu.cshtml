@{
    ViewData["Title"] = "Vòng Đời Phao";
    Layout = "_MainLayout";

    // Danh sách tuyến luồng từ controller
    var dsTuyenLuong = ViewBag.DanhSachTuyenLuong as dynamic ?? new List<dynamic>();
}

@section Styles {
<link rel="stylesheet" href="~/css/phao.css" />
}

<!-- ═══════════════════ FLOW DIAGRAM PAGE ═══════════════════ -->
<div class="fd-page">

    <!-- Header -->
    <div class="fd-header">
        <div>
            <div class="d-flex align-items-center gap-2 mb-1">
                <a href="@Url.Action("Dashboard", "Phao")" class="btn btn-sm btn-light border fw-semibold text-secondary"
                   style="border-radius:8px;">
                    <i class="bi bi-arrow-left me-1"></i>Quay lại
                </a>
            </div>
            <h4 class="fw-bold mb-1 text-dark">Sơ đồ luồng di chuyển phao</h4>
            <div class="text-muted small">Theo dõi đường di chuyển của phao theo vị trí và thời gian.</div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-light border fw-semibold text-secondary" style="border-radius:8px;padding:9px 18px;">
                <i class="bi bi-printer me-1"></i>In báo cáo
            </button>
            <button class="btn fw-semibold d-flex align-items-center gap-2"
                    style="border-radius:8px;background:#1d4ed8;color:#fff;padding:9px 18px;">
                <i class="bi bi-download"></i>Xuất Excel
            </button>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="fd-toolbar-bar">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <div>
                <div class="fd-label">TUYẾN LUỒNG</div>
                <select id="fdTuyenLuongSelect" class="fd-sel">
                    <option value="">-- Tất cả tuyến --</option>
                    @foreach (var tl in dsTuyenLuong)
                    {
                        <option value="@tl.Id">@tl.TenTuyen (@tl.MaTuyen)</option>
                    }
                </select>
            </div>
            <div>
                <div class="fd-label">LỌC THEO PHAO</div>
                <input id="fdFilterInput" class="fd-search" type="text" placeholder="Nhập mã phao…">
            </div>
            <div class="fd-legend-row">
                <span class="fd-leg"><span class="fd-legdot" style="background:#22c55e;"></span>Hoạt động</span>
                <span class="fd-leg"><span class="fd-legdot" style="background:#ef4444;"></span>Thu hồi</span>
                <span class="fd-leg"><span class="fd-legdot" style="background:#f59e0b;"></span>Kho</span>
                <span class="fd-leg"><span class="fd-legdot" style="background:#f97316;"></span>Sự cố</span>
                <span class="fd-leg"><span class="fd-legdot" style="background:#0ea5e9;"></span>Bảo trì</span>
                <span class="fd-leg">
                    <span style="display:inline-block;width:22px;height:0;border-bottom:2px dashed #888;vertical-align:middle;margin-right:4px;"></span>Thu hồi về
                </span>
                <span class="fd-leg">
                    <span style="display:inline-block;width:22px;height:0;border-bottom:3px dotted #888;vertical-align:middle;margin-right:4px;"></span>Kho
                </span>
            </div>
        </div>
        <div class="d-flex align-items-center gap-2">
            <button id="fdZoomOut" class="fd-zbtn"><i class="bi bi-dash-lg"></i></button>
            <span id="fdZoomLabel" class="fd-zlabel">100%</span>
            <button id="fdZoomIn" class="fd-zbtn"><i class="bi bi-plus-lg"></i></button>
            <button id="fdZoomReset" class="fd-zbtn" title="Reset zoom"><i class="bi bi-arrows-fullscreen"></i></button>
        </div>
    </div>

    <!-- Flow Diagram Viewport -->
    <div class="fd-card-wrap">
        <div id="fdViewport">
            <div id="fdInner">
                <div id="fdGrid">
                    <div class="fd-loading" id="fdLoadingIndicator">
                        <i class="bi bi-hourglass-split me-2"></i> Đang tải dữ liệu vòng đời phao...
                    </div>
                </div>
                <canvas id="fdCanvas" style="position:absolute;top:0;left:0;pointer-events:none;"></canvas>
            </div>
        </div>
        <div id="fdTooltip"
             style="display:none;position:fixed;z-index:9999;background:#1e293b;color:#fff;padding:8px 14px;border-radius:8px;font-size:.8rem;pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.3);">
        </div>
    </div>

    <!-- Status bar -->
    <div class="fd-statusbar">
        <span id="fdStatusText">Đang tải...</span>
        <span class="text-muted" style="font-size:.78rem;">Ctrl + Scroll = Zoom &nbsp;·&nbsp; Kéo chuột = Pan
            &nbsp;·&nbsp; Click node = Chi tiết</span>
    </div>

</div>

<!-- Node Detail Modal -->
<div class="modal fade" id="fdNodeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:460px;">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0">
                <div class="d-flex align-items-center gap-2">
                    <span id="fdNodeDot"
                          style="width:14px;height:14px;border-radius:50%;display:inline-block;flex-shrink:0;"></span>
                    <h6 class="modal-title fw-bold mb-0" id="fdNodeTitle">Chi tiết phao</h6>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-2">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="tl-label mb-1">MÃ PHAO</div>
                        <div class="fw-bold text-primary" style="font-size:1.05rem;" id="fdNodeId">---</div>
                    </div>
                    <div class="col-6">
                        <div class="tl-label mb-1">VỊ TRÍ</div>
                        <div class="fw-bold text-dark" id="fdNodePos">---</div>
                    </div>
                    <div class="col-6">
                        <div class="tl-label mb-1">NĂM</div>
                        <div class="fw-bold text-dark" id="fdNodeYear">---</div>
                    </div>
                    <div class="col-6">
                        <div class="tl-label mb-1">TRẠNG THÁI</div>
                        <div id="fdNodeStatus"
                             style="display:inline-block;padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:700;">---</div>
                    </div>
                    <div class="col-12">
                        <div class="tl-label mb-1">GHI CHÚ</div>
                        <div class="text-secondary" id="fdNodeNote" style="font-size:.88rem;">---</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top-0 pt-0">
                <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="~/js/phao/vongdoi.js" asp-append-version="true"></script>
}
