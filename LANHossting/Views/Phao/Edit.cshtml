@model LANHossting.ViewModels.Buoy.PhaoEditViewModel
@{
    ViewData["Title"] = "Sửa Phao — " + Model.Phao.TenPhao;
    Layout = "_MainLayout";
}

@section Styles {
<style>
    .edit-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,.08);
        border: none;
        margin-bottom: 24px;
    }
    .edit-card .card-header {
        background: transparent;
        border-bottom: 1px solid #e2e8f0;
        padding: 16px 24px;
        font-weight: 700;
        font-size: .95rem;
        color: #1e293b;
    }
    .edit-card .card-header i { margin-right: 8px; }
    .edit-card .card-body { padding: 20px 24px; }
    .page-header { margin-bottom: 24px; }
    .page-header h4 { font-weight: 800; color: #1e293b; margin-bottom: 4px; }
    .form-label { font-weight: 600; color: #475569; font-size: .82rem; margin-bottom: 4px; }
    .form-control, .form-select { border-radius: 10px; border: 1px solid #e2e8f0; font-size: .88rem; }
    .form-control:focus, .form-select:focus { border-color: var(--primary, #2563eb); box-shadow: 0 0 0 3px rgba(37,99,235,.1); }
    .section-blue .card-header { color: var(--primary, #2563eb); }
    .section-green .card-header { color: #059669; }
    .section-orange .card-header { color: #d97706; }
    .section-purple .card-header { color: #7c3aed; }
    .section-red .card-header { color: #dc2626; }
    .coord-readonly { background: #f1f5f9; color: #475569; font-weight: 600; }
</style>
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="page-header d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "Phao")" class="text-decoration-none">Quản Lý Phao</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("ChiTiet", "Phao", new { id = Model.Phao.Id })" class="text-decoration-none">Chi Tiết</a></li>
                    <li class="breadcrumb-item active">Sửa</li>
                </ol>
            </nav>
            <h4 class="mb-0"><i class="bi bi-pencil-square me-2 text-primary"></i>Sửa Phao: @Model.Phao.TenPhao</h4>
        </div>
        <a href="@Url.Action("ChiTiet", "Phao", new { id = Model.Phao.Id })" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            <i class="bi bi-x-lg me-1"></i>Hủy
        </a>
    </div>

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-1"></i>
            @Html.ValidationSummary(false, "", new { @class = "mb-0" })
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form asp-action="Edit" asp-controller="Phao" method="post" id="editPhaoForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Phao.Id" />

        <div class="row">
            <!-- I. THÔNG TIN CHUNG -->
            <div class="col-lg-6">
                <div class="card edit-card section-blue">
                    <div class="card-header"><i class="bi bi-info-circle-fill"></i>I. Thông Tin Chung</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Ký hiệu tài sản</label>
                                <input asp-for="Phao.KyHieuTaiSan" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Mã phao đầy đủ <span class="text-danger">*</span></label>
                                <input asp-for="Phao.MaPhaoDayDu" class="form-control" />
                                <span asp-validation-for="Phao.MaPhaoDayDu" class="text-danger small"></span>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Tên phao</label>
                                <input asp-for="Phao.TenPhao" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Số phao</label>
                                <input asp-for="Phao.SoPhaoHienTai" class="form-control" type="number" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Thời gian sử dụng (năm)</label>
                                <input asp-for="Phao.ThoiGianSuDung" class="form-control" type="number" min="0" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Thời điểm thay, thả</label>
                                <input asp-for="Phao.ThoiDiemThayTha" class="form-control" type="date" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Sửa chữa gần nhất</label>
                                <input asp-for="Phao.ThoiDiemSuaChuaGanNhat" class="form-control" type="date" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hình dạng</label>
                                <input asp-for="Phao.HinhDang" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kết cấu, vật liệu</label>
                                <input asp-for="Phao.VatLieu" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Màu sắc</label>
                                <input asp-for="Phao.MauSac" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Chiều cao toàn bộ (m)</label>
                                <input asp-for="Phao.ChieuCaoToanBo" class="form-control" type="number" step="0.01" />
                            </div>
                            <!-- Trạng thái hoạt động — đặt đây để nằm trước tuyến/vị trí -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">Trạng thái hoạt động <span class="text-danger">*</span></label>
                                <select asp-for="Phao.TrangThaiHoatDong" class="form-select" id="ddlTrangThaiHoatDong">
                                    <option value="">— Chọn trạng thái —</option>
                                    <option value="Trên luồng">Trên luồng</option>
                                    <option value="Thu hồi">Thu hồi</option>
                                    <option value="Cho thuê">Cho thuê</option>
                                    <option value="Sửa chữa">Sửa chữa</option>
                                    <option value="Mất dấu">Mất dấu</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tình trạng (tự động)</label>
                                <input type="text" id="txtTinhTrangDisplay" class="form-control coord-readonly" readonly
                                       placeholder="Suy ra từ trạng thái hoạt động" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- II. XÍCH PHAO & III. XÍCH RÙA -->
            <div class="col-lg-6">
                <div class="card edit-card section-green">
                    <div class="card-header"><i class="bi bi-link-45deg"></i>II. Xích Phao</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Đường kính (mm)</label>
                                <input asp-for="Phao.XichPhao_DuongKinh" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Chiều dài (m)</label>
                                <input asp-for="Phao.XichPhao_ChieuDai" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Thời điểm sử dụng</label>
                                <input asp-for="Phao.XichPhao_ThoiDiemSuDung" class="form-control" type="date" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card edit-card section-green">
                    <div class="card-header"><i class="bi bi-link"></i>III. Xích Rùa</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Đường kính (mm)</label>
                                <input asp-for="Phao.XichRua_DuongKinh" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Chiều dài (m)</label>
                                <input asp-for="Phao.XichRua_ChieuDai" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Thời điểm sử dụng</label>
                                <input asp-for="Phao.XichRua_ThoiDiemSuDung" class="form-control" type="date" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IV. RÙA & QUẢN LÝ -->
            <div class="col-lg-6">
                <div class="card edit-card section-orange">
                    <div class="card-header"><i class="bi bi-geo-alt-fill"></i>IV. Rùa & Quản Lý</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Trọng lượng rùa (tấn)</label>
                                <input asp-for="Phao.Rua_TrongLuong" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Thời điểm sử dụng rùa</label>
                                <input asp-for="Phao.Rua_ThoiDiemSuDung" class="form-control" type="date" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Trạm quản lý</label>
                                <select asp-for="Phao.TramQuanLyId" asp-items="Model.DanhSachTramQuanLy" class="form-select">
                                    <option value="">— Chọn trạm —</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tỉnh / Thành phố</label>
                                <select asp-for="Phao.TinhThanhPhoId" asp-items="Model.DanhSachTinhThanhPho" class="form-select">
                                    <option value="">— Chọn tỉnh —</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Đơn vị quản lý</label>
                                <select asp-for="Phao.DonViQuanLyId" asp-items="Model.DanhSachDonVi" class="form-select">
                                    <option value="">— Chọn đơn vị —</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Đơn vị vận hành</label>
                                <select asp-for="Phao.DonViVanHanhId" asp-items="Model.DanhSachDonVi" class="form-select">
                                    <option value="">— Chọn đơn vị —</option>
                                </select>
                            </div>
                            <!-- Tuyến luồng (enable chỉ khi "Trên luồng") -->
                            <div class="col-md-6" id="grpTuyenLuong">
                                <label class="form-label">Tuyến luồng <span class="text-danger" id="lblTuyenRequired">*</span></label>
                                <select asp-for="Phao.TuyenLuongId" asp-items="Model.DanhSachTuyenLuong" class="form-select" id="ddlTuyenLuong" disabled>
                                    <option value="">— Chọn tuyến —</option>
                                </select>
                            </div>

                            <!-- Vị trí phao (lọc theo tuyến, enable chỉ khi "Trên luồng") -->
                            <div class="col-md-6" id="grpViTri">
                                <label class="form-label">Vị trí phao báo hiệu <span class="text-danger" id="lblViTriRequired">*</span></label>
                                <select asp-for="Phao.ViTriPhaoBHHienTaiId" class="form-select" id="ddlViTriPhao" disabled>
                                    <option value="">— Chọn vị trí —</option>
                                </select>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label">Tọa độ thiết kế (readonly)</label>
                                <input type="text" id="txtToaDoThietKe" class="form-control coord-readonly" readonly
                                       value="" placeholder="Chọn vị trí để hiển thị tọa độ" />
                            </div>

                            <!-- Ghi chú lịch sử (tuỳ chọn) -->
                            <div class="col-md-12">
                                <label class="form-label">Ghi chú lịch sử hoạt động</label>
                                <input asp-for="Phao.GhiChuLichSu" class="form-control" placeholder="Ghi chú khi có thay đổi (không bắt buộc)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Diện tích (m²)</label>
                                <input asp-for="Phao.DienTich" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số quyết định tăng</label>
                                <input asp-for="Phao.SoQuyetDinhTang" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ngày quyết định tăng</label>
                                <input asp-for="Phao.NgayQuyetDinhTang" class="form-control" type="date" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V. ĐÈN BÁO HIỆU -->
            <div class="col-lg-6">
                <div class="card edit-card section-red">
                    <div class="card-header"><i class="bi bi-lightbulb-fill"></i>V. Đèn Báo Hiệu</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Chủng loại đèn</label>
                                <input asp-for="Phao.Den_ChungLoai" class="form-control" />
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="form-check form-switch">
                                    <input asp-for="Phao.Den_KetNoiAIS" class="form-check-input" type="checkbox" role="switch" id="chkAIS" />
                                    <label class="form-check-label fw-semibold" for="chkAIS">Kết nối AIS</label>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Đặc tính ánh sáng</label>
                                <input asp-for="Phao.Den_DacTinhAnhSang" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Chiều xa tâm sáng (hải lý)</label>
                                <input asp-for="Phao.Den_ChieuXaTamSang" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Chiều cao tâm sáng hải đồ (m)</label>
                                <input asp-for="Phao.Den_ChieuCaoTamSangHaiDo" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Nguồn cấp năng lượng</label>
                                <input asp-for="Phao.Den_NguonCapNangLuong" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Thời điểm sử dụng đèn</label>
                                <input asp-for="Phao.Den_ThoiDiemSuDung" class="form-control" type="date" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sửa chữa gần nhất (đèn)</label>
                                <input asp-for="Phao.Den_ThoiDiemSuaChua" class="form-control" type="date" />
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Số QĐ tăng đèn</label>
                                <input asp-for="Phao.Den_SoQuyetDinhTang" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit -->
        <div class="d-flex justify-content-end gap-2 mb-5">
            <a href="@Url.Action("ChiTiet", "Phao", new { id = Model.Phao.Id })" class="btn btn-outline-secondary rounded-pill px-4">
                <i class="bi bi-x-lg me-1"></i>Hủy
            </a>
            <button type="submit" class="btn btn-primary rounded-pill px-4">
                <i class="bi bi-check-lg me-1"></i>Lưu Thay Đổi
            </button>
        </div>
    </form>
</div>

@section Scripts {
<script>
    // ── Constants ──────────────────────────────────────────────────────────────
    var TREN_LUONG = 'Trên luồng';

    // ── Elements ───────────────────────────────────────────────────────────────
    var ddlTrangThai = document.getElementById('ddlTrangThaiHoatDong');
    var ddlTuyen     = document.getElementById('ddlTuyenLuong');
    var ddlViTri     = document.getElementById('ddlViTriPhao');
    var txtToaDo     = document.getElementById('txtToaDoThietKe');
    var txtTinhTrang = document.getElementById('txtTinhTrangDisplay');

    // ── Helpers ────────────────────────────────────────────────────────────────
    function setTuyenViTriEnabled(enabled) {
        ddlTuyen.disabled = !enabled;
        ddlViTri.disabled = !enabled;
        document.getElementById('lblTuyenRequired').style.display  = enabled ? '' : 'none';
        document.getElementById('lblViTriRequired').style.display  = enabled ? '' : 'none';
        if (!enabled) {
            ddlTuyen.value = '';
            ddlViTri.innerHTML = '<option value="">— Chọn vị trí —</option>';
            txtToaDo.value = '';
        }
    }

    function inferTinhTrang(trangThaiHoatDong) {
        return trangThaiHoatDong === TREN_LUONG ? 'Có sử dụng' : 'Không sử dụng';
    }

    // ── Load ViTri by Tuyến (AJAX) ─────────────────────────────────────────────
    function loadViTriByTuyen(tuyenId, selectedViTriId) {
        if (!tuyenId) {
            ddlViTri.innerHTML = '<option value="">— Chọn vị trí —</option>';
            txtToaDo.value = '';
            return;
        }
        fetch('@Url.Action("GetViTriByTuyenLuong", "Phao")/' + tuyenId)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var html = '<option value="">— Chọn vị trí —</option>';
                data.forEach(function(v) {
                    var sel = (selectedViTriId && v.id == selectedViTriId) ? ' selected' : '';
                    html += '<option value="' + v.id + '"' + sel + '>' + v.maPhaoBH + '</option>';
                });
                ddlViTri.innerHTML = html;
                // trigger tọa độ nếu có giá trị được chọn
                if (ddlViTri.value) ddlViTri.dispatchEvent(new Event('change'));
            });
    }

    // ── Load tọa độ khi chọn ViTri ─────────────────────────────────────────────
    ddlViTri.addEventListener('change', function() {
        var viTriId = this.value;
        if (!viTriId) { txtToaDo.value = ''; return; }
        fetch('@Url.Action("GetViTriInfo", "Phao")/' + viTriId)
            .then(function(r) { return r.json(); })
            .then(function(d) { txtToaDo.value = d.toaDoThietKe || '—'; })
            .catch(function() { txtToaDo.value = 'Không lấy được tọa độ'; });
    });

    // ── Khi TrangThaiHoatDong thay đổi ─────────────────────────────────────────
    ddlTrangThai.addEventListener('change', function() {
        var val = this.value;
        txtTinhTrang.value = inferTinhTrang(val);
        if (val === TREN_LUONG) {
            setTuyenViTriEnabled(true);
        } else {
            setTuyenViTriEnabled(false);
            // Clear hidden fields so server receives null
            ddlTuyen.value = '';
        }
    });

    // ── Khi TuyenLuong thay đổi ────────────────────────────────────────────────
    ddlTuyen.addEventListener('change', function() {
        loadViTriByTuyen(this.value, null);
    });

    // ── Khởi tạo trạng thái ban đầu ────────────────────────────────────────────
    (function init() {
        var currentTrangThai = ddlTrangThai.value;
        txtTinhTrang.value = inferTinhTrang(currentTrangThai);

        if (currentTrangThai === TREN_LUONG) {
            setTuyenViTriEnabled(true);
            var currentTuyen  = '@(Model.Phao.TuyenLuongId?.ToString() ?? "")';
            var currentViTri  = '@(Model.Phao.ViTriPhaoBHHienTaiId?.ToString() ?? "")';
            if (currentTuyen) {
                ddlTuyen.value = currentTuyen;
                loadViTriByTuyen(currentTuyen, currentViTri ? parseInt(currentViTri) : null);
            }
        } else {
            setTuyenViTriEnabled(false);
        }
    })();
</script>
}
