@model LANHossting.ViewModels.Buoy.PhaoEditViewModel
@{
    ViewData["Title"] = "Sửa Phao — " + Model.Phao.TenPhao;
    Layout = "_MainLayout";
}

@section Styles {
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<link rel="stylesheet" href="~/css/phao.css" />
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="page-header d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "Phao")" class="text-decoration-none">Quản Lý Phao</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("ChiTiet", "Phao", new { id = Model.Phao.Id })" class="text-decoration-none">Chi Tiết</a></li>
                    <li class="breadcrumb-item active">Sửa</li>
                </ol>
            </nav>
            <h4 class="mb-0"><i class="bi bi-pencil-square me-2 text-primary"></i>Sửa Phao: @Model.Phao.TenPhao</h4>
        </div>
        <a href="@Url.Action("ChiTiet", "Phao", new { id = Model.Phao.Id })" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            <i class="bi bi-x-lg me-1"></i>Hủy
        </a>
    </div>

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-1"></i>
            @Html.ValidationSummary(false, "", new { @class = "mb-0" })
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form asp-action="Edit" asp-controller="Phao" method="post" id="editPhaoForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Phao.Id" />

        <div class="row">
            <!-- I. THÔNG TIN CHUNG -->
            <div class="col-lg-6">
                <div class="card edit-card section-blue">
                    <div class="card-header"><i class="bi bi-info-circle-fill"></i>I. Thông Tin Chung</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Ký hiệu tài sản</label>
                                <input asp-for="Phao.KyHieuTaiSan" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Mã phao đầy đủ <span class="text-danger">*</span></label>
                                <input asp-for="Phao.MaPhaoDayDu" class="form-control" />
                                <span asp-validation-for="Phao.MaPhaoDayDu" class="text-danger small"></span>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Tên phao</label>
                                <input asp-for="Phao.TenPhao" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Số phao</label>
                                <input asp-for="Phao.SoPhaoHienTai" class="form-control" type="number" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Thời gian sử dụng (năm)</label>
                                <input asp-for="Phao.ThoiGianSuDung" class="form-control" type="number" min="0" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Thời điểm thay, thả</label>
                                <input asp-for="Phao.ThoiDiemThayTha" class="form-control" type="date" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Sửa chữa gần nhất</label>
                                <input asp-for="Phao.ThoiDiemSuaChuaGanNhat" class="form-control" type="date" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hình dạng</label>
                                <input asp-for="Phao.HinhDang" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Kết cấu, vật liệu</label>
                                <input asp-for="Phao.VatLieu" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Màu sắc</label>
                                <input asp-for="Phao.MauSac" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Chiều cao toàn bộ (m)</label>
                                <input asp-for="Phao.ChieuCaoToanBo" class="form-control" type="number" step="0.01" />
                            </div>
                            <!-- Trạng thái hoạt động — đặt đây để nằm trước tuyến/vị trí -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">Trạng thái hoạt động <span class="text-danger">*</span></label>
                                <select asp-for="Phao.TrangThaiHoatDong" class="form-select" id="ddlTrangThaiHoatDong">
                                    <option value="">— Chọn trạng thái —</option>
                                    <option value="Trên luồng">Trên luồng</option>
                                    <option value="Thu hồi">Thu hồi</option>
                                    <option value="Cho thuê">Cho thuê</option>
                                    <option value="Sửa chữa">Sửa chữa</option>
                                    <option value="Mất dấu">Mất dấu</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tình trạng (tự động)</label>
                                <input type="text" id="txtTinhTrangDisplay" class="form-control coord-readonly" readonly
                                       placeholder="Suy ra từ trạng thái hoạt động" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- II. XÍCH PHAO & III. XÍCH RÙA -->
            <div class="col-lg-6">
                <div class="card edit-card section-green">
                    <div class="card-header"><i class="bi bi-link-45deg"></i>II. Xích Phao</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Đường kính (mm)</label>
                                <input asp-for="Phao.XichPhao_DuongKinh" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Chiều dài (m)</label>
                                <input asp-for="Phao.XichPhao_ChieuDai" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Thời điểm sử dụng</label>
                                <input asp-for="Phao.XichPhao_ThoiDiemSuDung" class="form-control" type="date" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card edit-card section-green">
                    <div class="card-header"><i class="bi bi-link"></i>III. Xích Rùa</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Đường kính (mm)</label>
                                <input asp-for="Phao.XichRua_DuongKinh" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Chiều dài (m)</label>
                                <input asp-for="Phao.XichRua_ChieuDai" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Thời điểm sử dụng</label>
                                <input asp-for="Phao.XichRua_ThoiDiemSuDung" class="form-control" type="date" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IV. RÙA & QUẢN LÝ -->
            <div class="col-lg-6">
                <div class="card edit-card section-orange">
                    <div class="card-header"><i class="bi bi-geo-alt-fill"></i>IV. Rùa & Quản Lý</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Trọng lượng rùa (tấn)</label>
                                <input asp-for="Phao.Rua_TrongLuong" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Thời điểm sử dụng rùa</label>
                                <input asp-for="Phao.Rua_ThoiDiemSuDung" class="form-control" type="date" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Trạm quản lý</label>
                                <select asp-for="Phao.TramQuanLyId" asp-items="Model.DanhSachTramQuanLy" class="form-select">
                                    <option value="">— Chọn trạm —</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tỉnh / Thành phố</label>
                                <select asp-for="Phao.TinhThanhPhoId" asp-items="Model.DanhSachTinhThanhPho" class="form-select">
                                    <option value="">— Chọn tỉnh —</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Đơn vị quản lý</label>
                                <select asp-for="Phao.DonViQuanLyId" asp-items="Model.DanhSachDonVi" class="form-select">
                                    <option value="">— Chọn đơn vị —</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Đơn vị vận hành</label>
                                <select asp-for="Phao.DonViVanHanhId" asp-items="Model.DanhSachDonVi" class="form-select">
                                    <option value="">— Chọn đơn vị —</option>
                                </select>
                            </div>
                            <!-- Tuyến luồng (enable chỉ khi "Trên luồng") -->
                            <div class="col-md-6" id="grpTuyenLuong">
                                <label class="form-label">Tuyến luồng <span class="text-danger" id="lblTuyenRequired">*</span></label>
                                <select asp-for="Phao.TuyenLuongId" asp-items="Model.DanhSachTuyenLuong" class="form-select" id="ddlTuyenLuong" disabled>
                                    <option value="">— Chọn tuyến —</option>
                                </select>
                            </div>

                            <!-- Vị trí phao (lọc theo tuyến, enable chỉ khi "Trên luồng") -->
                            <div class="col-md-6" id="grpViTri">
                                <label class="form-label">Vị trí phao báo hiệu <span class="text-danger" id="lblViTriRequired">*</span></label>
                                <select asp-for="Phao.ViTriPhaoBHHienTaiId" class="form-select" id="ddlViTriPhao" disabled>
                                    <option value="">— Chọn vị trí —</option>
                                </select>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label">Tọa độ thiết kế (readonly)</label>
                                <input type="text" id="txtToaDoThietKe" class="form-control coord-readonly" readonly
                                       value="" placeholder="Chọn vị trí để hiển thị tọa độ" />
                            </div>

                            <!-- Ghi chú lịch sử (tuỳ chọn) -->
                            <div class="col-md-12">
                                <label class="form-label">Ghi chú lịch sử hoạt động</label>
                                <input asp-for="Phao.GhiChuLichSu" class="form-control" placeholder="Ghi chú khi có thay đổi (không bắt buộc)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Diện tích (m²)</label>
                                <input asp-for="Phao.DienTich" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số quyết định tăng</label>
                                <input asp-for="Phao.SoQuyetDinhTang" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ngày quyết định tăng</label>
                                <input asp-for="Phao.NgayQuyetDinhTang" class="form-control" type="date" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- V. ĐÈN BÁO HIỆU -->
            <div class="col-lg-6">
                <div class="card edit-card section-red">
                    <div class="card-header"><i class="bi bi-lightbulb-fill"></i>V. Đèn Báo Hiệu</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Chủng loại đèn</label>
                                <input asp-for="Phao.Den_ChungLoai" class="form-control" />
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="form-check form-switch">
                                    <input asp-for="Phao.Den_KetNoiAIS" class="form-check-input" type="checkbox" role="switch" id="chkAIS" />
                                    <label class="form-check-label fw-semibold" for="chkAIS">Kết nối AIS</label>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Đặc tính ánh sáng</label>
                                <input asp-for="Phao.Den_DacTinhAnhSang" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Chiều xa tâm sáng (hải lý)</label>
                                <input asp-for="Phao.Den_ChieuXaTamSang" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Chiều cao tâm sáng hải đồ (m)</label>
                                <input asp-for="Phao.Den_ChieuCaoTamSangHaiDo" class="form-control" type="number" step="0.01" />
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Nguồn cấp năng lượng</label>
                                <input asp-for="Phao.Den_NguonCapNangLuong" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Thời điểm sử dụng đèn</label>
                                <input asp-for="Phao.Den_ThoiDiemSuDung" class="form-control" type="date" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sửa chữa gần nhất (đèn)</label>
                                <input asp-for="Phao.Den_ThoiDiemSuaChua" class="form-control" type="date" />
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Số QĐ tăng đèn</label>
                                <input asp-for="Phao.Den_SoQuyetDinhTang" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit -->
        <div class="d-flex justify-content-end gap-2 mb-5">
            <a href="@Url.Action("ChiTiet", "Phao", new { id = Model.Phao.Id })" class="btn btn-outline-secondary rounded-pill px-4">
                <i class="bi bi-x-lg me-1"></i>Hủy
            </a>
            <button type="submit" class="btn btn-primary rounded-pill px-4">
                <i class="bi bi-check-lg me-1"></i>Lưu Thay Đổi
            </button>
        </div>
    </form>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Razor-resolved config (cannot be in external .js file)
    var EDIT_CONFIG = {
        urls: {
            viTriByTuyen: '@Url.Action("GetViTriByTuyenLuong", "Phao")',
            viTriInfo:    '@Url.Action("GetViTriInfo", "Phao")'
        },
        model: {
            currentTuyen: '@(Model.Phao.TuyenLuongId?.ToString() ?? "")',
            currentViTri: '@(Model.Phao.ViTriPhaoBHHienTaiId?.ToString() ?? "")'
        }
    };
</script>
<script src="~/js/phao/edit.js"></script>
}
