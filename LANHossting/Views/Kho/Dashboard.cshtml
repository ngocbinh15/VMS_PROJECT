@{
    ViewData["Title"] = "Quản Lý Kho";
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --secondary: #4cc9f0;
            --success: #10b981;
            --danger: #ef476f;
            --warning: #f59e0b;
            --border-radius: 16px;
            --card-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #334155;
            padding-top: 80px;
            overflow-x: hidden;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            padding: 12px 0;
        }

        .brand-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 800;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            border: none;
            padding: 24px;
            box-shadow: var(--card-shadow);
            transition: 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .stat-icon-wrapper {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 16px;
        }

        .table-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            border: none;
            overflow: hidden;
        }

        .table-custom thead th {
            background: #f8fafc;
            color: #64748b;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }

        .table-custom td {
            padding: 16px 20px;
            vertical-align: middle;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .currency-num {
            font-feature-settings: "tnum";
            font-weight: 600;
        }

        .badge-modern {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .btn-primary-modern {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
            border-radius: 10px;
            padding: 12px 20px;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(67, 97, 238, 0.4);
            transition: 0.2s;
        }

        .btn-primary-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(67, 97, 238, 0.5);
        }

        .btn-outline-modern {
            background: white;
            border: 2px solid #e2e8f0;
            color: #475569;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-outline-modern:hover {
            border-color: var(--success);
            color: var(--success);
            background: #ecfdf5;
        }

        .search-input-modern {
            background: #f1f5f9;
            border: none;
            border-radius: 12px;
            padding: 12px 16px 12px 45px;
        }

        .search-input-modern:focus {
            background: white;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .action-btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .btn-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border: 2px solid transparent;
            border-radius: 12px;
            background: #f8fafc;
            color: #64748b;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .btn-action.active-import {
            background: #ecfdf5;
            border-color: #10b981;
            color: #059669;
        }

        .btn-action.active-export {
            background: #fef2f2;
            border-color: #ef476f;
            color: #be123c;
        }

        .btn-action.active-transfer {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #b45309;
        }

        .search-results-dropdown {
            position: absolute;
            top: 105%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            z-index: 1050;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            padding: 8px;
            border: 1px solid #e2e8f0;
        }

        .result-item {
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-item:hover {
            background-color: #f1f5f9;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* ═══ TOAST NOTIFICATION ═══ */
        .toast-container-custom {
            position: fixed;
            top: 90px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast-custom {
            pointer-events: auto;
            min-width: 340px;
            max-width: 420px;
            padding: 14px 18px;
            border-radius: 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            box-shadow: 0 8px 30px -8px rgba(0,0,0,0.15);
            animation: toastSlideIn 0.35s cubic-bezier(0.21,1.02,0.73,1) forwards;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .toast-custom.toast-hiding {
            animation: toastSlideOut 0.3s ease-in forwards;
        }
        .toast-custom.toast-success {
            background: #ecfdf5; border-left: 4px solid #10b981; color: #065f46;
        }
        .toast-custom.toast-error {
            background: #fef2f2; border-left: 4px solid #ef4444; color: #991b1b;
        }
        .toast-custom.toast-warning {
            background: #fffbeb; border-left: 4px solid #f59e0b; color: #92400e;
        }
        .toast-icon { font-size: 1.3rem; flex-shrink: 0; margin-top: 1px; }
        .toast-body { flex: 1; }
        .toast-close {
            background: none; border: none; font-size: 1.1rem; opacity: 0.5;
            cursor: pointer; padding: 0; line-height: 1; flex-shrink: 0;
        }
        .toast-close:hover { opacity: 1; }
        @@keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(60px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        @@keyframes toastSlideOut {
            from { opacity: 1; transform: translateX(0); }
            to   { opacity: 0; transform: translateX(60px); }
        }

        /* ═══ INLINE VALIDATION ═══ */
        .inline-error {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            animation: fadeIn 0.25s ease-out;
        }
        .inline-error i { font-size: 0.75rem; }
        .form-control.is-invalid-custom,
        .form-select.is-invalid-custom {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.15rem rgba(220,53,69,0.2);
        }

        /* ═══ CONFIRM MODAL ═══ */
        .confirm-modal-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.35);
            z-index: 10000;
            display: flex; align-items: center; justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        .confirm-modal-box {
            background: white; border-radius: 16px; padding: 28px 32px;
            max-width: 400px; width: 90%;
            box-shadow: 0 20px 50px -12px rgba(0,0,0,0.2);
            text-align: center;
        }
        .confirm-modal-box h6 { font-weight: 700; margin-bottom: 8px; }
        .confirm-modal-box p { color: #64748b; font-size: 0.92rem; margin-bottom: 20px; }
    </style>
</head>

<body>
    <!-- Toast container -->
    <div id="toastContainer" class="toast-container-custom"></div>

<nav class="navbar navbar-expand-lg fixed-top glass-nav">
    <div class="container-fluid px-4 d-flex justify-content-between align-items-center">

        <!-- Logo bên trái -->
        <a class="navbar-brand m-0 p-0" href="#">
            <img src="~/image_2.png"
                 asp-append-version="true"
                 alt="Tổng Công ty Bảo đảm An toàn Hàng hải Việt Nam"
                 height="60">
        </a>

        <!-- Nhóm nút bên phải -->
        <div class="d-flex gap-3 align-items-center">
            <div class="dropdown">
                <select class="form-select form-select-sm rounded-pill bg-light border-0 fw-semibold"
                        id="warehouseSelector"
                        onchange="switchWarehouse()">
                    <option value="">-- Chọn Kho --</option>
                </select>
            </div>

            <button class="btn btn-sm btn-outline-primary rounded-pill px-3 fw-semibold"
                    onclick="showHistory()">
                <i class="bi bi-clock-history me-1"></i>Nhật Ký
            </button>

            <button class="btn btn-sm btn-outline-danger rounded-pill px-3 fw-semibold"
                    onclick="logout()">
                <i class="bi bi-box-arrow-right me-1"></i>Đăng Xuất
            </button>
        </div>

    </div>
</nav>

    <div class="container-fluid px-4 py-4">
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-icon-wrapper bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-archive-fill"></i>
                    </div>
                    <h6 class="text-uppercase text-muted small mb-1">Tổng Vật Tư</h6>
                    <h2 class="fw-bold mb-0" id="totalItems">0</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-icon-wrapper bg-success bg-opacity-10 text-success">
                        <i class="bi bi-stack"></i>
                    </div>
                    <h6 class="text-uppercase text-muted small mb-1">Tổng Tồn Kho</h6>
                    <h2 class="fw-bold mb-0 currency-num" id="totalStock">0</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-icon-wrapper bg-warning bg-opacity-10 text-warning">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <h6 class="text-uppercase text-muted small mb-1">Tổng Thành Tiền</h6>
                    <h2 class="fw-bold mb-0 currency-num" id="totalValue">0</h2>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-12">
                <div class="table-card">
                    <div class="p-4 border-bottom bg-white">
                        <div class="row align-items-center">
                            <div class="col-lg-6 mb-3 mb-lg-0">
                                <div class="position-relative">
                                    <i class="bi bi-search position-absolute top-50 translate-middle-y ms-3 text-muted"></i>
                                    <input type="text" class="form-control search-input-modern" id="searchInput" placeholder="Tìm kiếm vật tư theo mã hoặc tên..." oninput="debounce(searchMaterial, 'main')">
                                    <div class="search-results-dropdown" id="searchResults"></div>
                                </div>
                            </div>
                            <div class="col-lg-6 d-flex gap-2 justify-content-lg-end">
                                <button class="btn btn-outline-modern" onclick="openActionModal()">
                                    <i class="bi bi-arrow-left-right me-2"></i>Giao Dịch
                                </button>
                                <button class="btn btn-outline-modern" data-bs-toggle="modal" data-bs-target="#addMaterialModal">
                                    <i class="bi bi-plus-circle me-2"></i>Thêm Vật Tư
                                </button>
                                <button class="btn btn-primary-modern" onclick="exportReport()">
                                    <i class="bi bi-file-earmark-excel me-2"></i>Xuất Excel
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-custom mb-0">
                            <thead>
                                <tr>
                                    <th class="ps-4 text-center" style="width:50px">#</th>
                                    <th>Mã Vật Tư</th>
                                    <th>Tên Vật Tư</th>
                                    <th>ĐVT</th>
                                    <th class="text-end">Đơn Giá</th>
                                    <th class="text-center">Tồn Kho</th>
                                    <th class="text-center">Khả Dụng</th>
                                    <th class="text-end pe-4">Thành Tiền</th>
                                </tr>
                            </thead>
                            <tbody id="materialTableBody"></tbody>
                        </table>
                    </div>
                    <div class="p-4 border-top bg-light d-flex justify-content-between align-items-center">
                        <span class="text-muted small">Hiển thị <span id="displayCount">0</span> vật tư</span>
                        <div id="pagination" class="d-flex gap-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 bg-light px-4 pt-4 pb-3">
                    <div>
                        <h5 class="fw-bold mb-1">Giao Dịch Vật Tư</h5>
                        <small class="text-muted" id="modalWarehouseName">Chưa chọn kho</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body px-4 py-3">
                    <div class="action-btn-group mb-4">
                        <button class="btn-action" onclick="selectAction('NHAP')">
                            <i class="bi bi-box-arrow-in-down fs-2 mb-2"></i>
                            <span class="small">NHẬP KHO</span>
                        </button>
                        <button class="btn-action" onclick="selectAction('XUAT')">
                            <i class="bi bi-box-arrow-up fs-2 mb-2"></i>
                            <span class="small">XUẤT KHO</span>
                        </button>
                        <button class="btn-action" onclick="selectAction('DIEUCHUYEN')">
                            <i class="bi bi-arrow-left-right fs-2 mb-2"></i>
                            <span class="small">ĐIỀU CHUYỂN</span>
                        </button>
                    </div>
                    
                    <!-- Kho đích (cho điều chuyển) -->
                    <div id="transferWarehouseSection" class="mb-3 d-none">
                        <label class="small fw-bold text-muted mb-2">KHO ĐÍCH (Điều Chuyển Đến)</label>
                        <select class="form-select" id="transferToWarehouse">
                            <option value="">-- Chọn kho đích --</option>
                        </select>
                    </div>

                    <!-- Form nhập thông tin -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="small fw-bold text-muted mb-2">VẬT TƯ <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="materialSearch" placeholder="Nhấn để chọn vật tư..." readonly onclick="clearMaterialSelection()" oninput="debounce(searchMaterialInModal, 'modal')">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearMaterialSelection()" title="Chọn lại vật tư">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                                <input type="hidden" id="selectedMaterialId">
                                <div class="search-results-dropdown" id="modalSearchResults"></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="small fw-bold text-muted mb-2">SỐ LƯỢNG <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="quantityInput" min="0.001" step="0.001" value="1">
                        </div>
                        <div class="col-md-3">
                            <label class="small fw-bold text-muted mb-2">ĐƠN GIÁ</label>
                            <input type="number" class="form-control" id="donGiaInput" min="0" step="0.01" value="0" placeholder="0">
                        </div>
                    </div>
                    
                    <!-- Thông tin bổ sung (chỉ hiện khi NHẬP) -->
                    <div id="nhapKhoExtraFields" class="d-none">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="small fw-bold text-muted mb-2">SỐ LÔ</label>
                                <input type="text" class="form-control" id="soLoInput" placeholder="VD: LOT2026-001">
                            </div>
                            <div class="col-md-4">
                                <label class="small fw-bold text-muted mb-2">NGÀY SẢN XUẤT</label>
                                <input type="date" class="form-control" id="ngaySanXuatInput">
                            </div>
                            <div class="col-md-4">
                                <label class="small fw-bold text-muted mb-2">NGÀY HẾT HẠN</label>
                                <input type="date" class="form-control" id="ngayHetHanInput">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="small fw-bold text-muted mb-2">NHÀ CUNG CẤP</label>
                                <input type="text" class="form-control" id="nhaCungCapInput" placeholder="Tên nhà cung cấp">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 mb-3">
                        <input type="text" class="form-control" id="noteInput" placeholder="Ghi chú (tuỳ chọn)">
                        <button class="btn btn-primary fw-bold px-4" onclick="commitAction()">
                            <i class="bi bi-plus-lg me-1"></i>Thêm
                        </button>
                    </div>
                    
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0">Danh Sách Dự Thảo</h6>
                        <span class="badge bg-primary rounded-pill" id="draftCount">0 mục</span>
                    </div>
                    <div class="position-relative" style="min-height: 200px;">
                        <div class="table-responsive" id="draftTableContainer" style="max-height: 250px; overflow-y: auto;">
                            <table class="table table-sm mb-0 align-middle">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="ps-3">Vật Tư</th>
                                        <th class="text-center">Hành động</th>
                                        <th class="text-end">Số lượng</th>
                                        <th class="text-end">Đơn giá</th>
                                        <th class="text-end">Thành tiền</th>
                                        <th class="text-end pe-3">Xoá</th>
                                    </tr>
                                </thead>
                                <tbody id="sessionListBody" class="border-top-0"></tbody>
                            </table>
                            <div id="emptyState" class="flex-column align-items-center justify-content-center text-muted p-4 h-100 w-100 position-absolute top-0 start-0 bg-white" style="z-index: 5; display: flex;">
                                <div class="bg-light rounded-circle p-3 mb-2"><i class="bi bi-basket2 fs-1 opacity-25"></i></div>
                                <small class="fw-semibold">Chưa có giao dịch nào</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tổng cộng -->
                    <div id="draftSummary" class="bg-light rounded-3 p-3 mt-3 d-none">
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted d-block">Tổng số dòng</small>
                                <strong id="summaryCount">0</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted d-block">Tổng số lượng</small>
                                <strong id="summaryQty">0</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted d-block">Tổng thành tiền</small>
                                <strong class="text-primary" id="summaryTotal">0 đ</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button type="button" class="btn btn-light rounded-3 fw-bold" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-dark rounded-3 fw-bold px-4" onclick="finishAndSave()">
                        <i class="bi bi-check-lg me-1"></i>Hoàn Tất
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══ NHẬT KÝ MODAL (full-featured) ═══ -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 bg-light px-4 pt-4 pb-3">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="bi bi-journal-text text-primary me-2"></i>Nhật Ký Giao Dịch</h5>
                        <small class="text-muted">Lịch sử tất cả phiếu Nhập/Xuất/Chuyển kho đã hoàn thành</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body px-4 py-3">
                    <!-- ── FILTERS ── -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Từ ngày</label>
                            <input type="date" class="form-control form-control-sm" id="nkFilterTuNgay">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Đến ngày</label>
                            <input type="date" class="form-control form-control-sm" id="nkFilterDenNgay">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Kho</label>
                            <select class="form-select form-select-sm" id="nkFilterKho">
                                <option value="">-- Tất cả --</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Loại</label>
                            <select class="form-select form-select-sm" id="nkFilterLoai">
                                <option value="">-- Tất cả --</option>
                                <option value="NHAP">Nhập kho</option>
                                <option value="XUAT">Xuất kho</option>
                                <option value="CHUYEN_DI">Chuyển kho</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted">Tìm vật tư</label>
                            <input type="text" class="form-control form-control-sm" id="nkFilterSearch" placeholder="Mã hoặc tên...">
                        </div>
                        <div class="col-md-2 d-flex align-items-end gap-1">
                            <button class="btn btn-sm btn-primary flex-fill" onclick="loadNhatKy(1)">
                                <i class="bi bi-search me-1"></i>Lọc
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="resetNhatKyFilter()">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ── TABLE ── -->
                    <div class="table-responsive" style="max-height: 450px;">
                        <table class="table table-hover mb-0 align-middle small">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th class="ps-3">Mã phiếu</th>
                                    <th>Loại</th>
                                    <th>Kho</th>
                                    <th>Người thực hiện</th>
                                    <th>Ngày</th>
                                    <th class="text-center">Số VT</th>
                                    <th class="text-end pe-3">Chi tiết</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                    <div id="emptyHistoryMsg" class="text-center text-muted py-5 d-none">
                        <i class="bi bi-inbox" style="font-size:2rem"></i>
                        <div class="mt-2">Chưa có nhật ký nào</div>
                    </div>

                    <!-- ── PAGINATION ── -->
                    <div class="d-flex justify-content-between align-items-center mt-3" id="nkPaginationArea" style="display:none!important">
                        <small class="text-muted" id="nkPaginationInfo"></small>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="nkPaginationList"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══ CHI TIẾT PHIẾU MODAL ═══ -->
    <div class="modal fade" id="transactionDetailModal" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0 px-4 pt-3 pb-2" id="detailModalHeader">
                    <div>
                        <h6 class="modal-title fw-bold mb-1" id="detailModalTitle">Chi Tiết Phiếu</h6>
                        <small id="detailModalSubtitle" class="text-muted">...</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body px-4 py-0">
                    <!-- ── PHIẾU INFO CARDS ── -->
                    <div class="row g-2 mb-3" id="detailInfoCards"></div>

                    <!-- ── DETAIL TABLE ── -->
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-striped table-hover mb-0 align-middle small">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th class="ps-3">Vật tư</th>
                                    <th>Kho</th>
                                    <th class="text-center">Loại</th>
                                    <th class="text-end">SL trước</th>
                                    <th class="text-end">Thay đổi</th>
                                    <th class="text-end">SL sau</th>
                                    <th>Thời gian</th>
                                    <th class="text-end pe-3">Người TH</th>
                                </tr>
                            </thead>
                            <tbody id="detailTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0 py-2 px-4">
                    <button type="button" class="btn btn-sm btn-secondary fw-bold" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addMaterialModal" tabindex="-1" style="z-index: 1070;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 bg-light px-4 pt-4 pb-3">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="bi bi-plus-circle-fill text-primary me-2"></i>Thêm Vật Tư Mới</h5>
                        <small class="text-muted">Điền đầy đủ thông tin vật tư cần thêm vào hệ thống</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body px-4 py-3">
                    <!-- Alert inside modal -->
                    <div id="addMatAlert"></div>

                    <form id="formThemVatTu" novalidate>
                        <!-- Row 1: Mã + Tên -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Mã Vật Tư <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="addMat_MaVatTu" placeholder="VD: VT-001" maxlength="50">
                                <div class="invalid-feedback">Mã vật tư là bắt buộc</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Tên Vật Tư <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="addMat_TenVatTu" placeholder="VD: Sơn chống gỉ" maxlength="200">
                                <div class="invalid-feedback">Tên vật tư là bắt buộc</div>
                            </div>
                        </div>

                        <!-- Row 2: Nhóm + ĐVT -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Nhóm Vật Tư <span class="text-danger">*</span></label>
                                <select class="form-select" id="addMat_NhomVatLieu">
                                    <option value="">-- Chọn nhóm --</option>
                                </select>
                                <div class="invalid-feedback">Nhóm vật tư là bắt buộc</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Đơn Vị Tính <span class="text-danger">*</span></label>
                                <select class="form-select" id="addMat_DonViTinh">
                                    <option value="">-- Chọn ĐVT --</option>
                                </select>
                                <div class="invalid-feedback">Đơn vị tính là bắt buộc</div>
                            </div>
                        </div>

                        <!-- Row 3: Đơn giá + Kho -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Đơn Giá (VNĐ) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="addMat_DonGia" min="0" step="0.01" value="0">
                                <div class="invalid-feedback">Đơn giá phải >= 0</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Kho <span class="text-danger">*</span></label>
                                <select class="form-select" id="addMat_KhoId">
                                    <option value="">-- Chọn kho --</option>
                                </select>
                                <div class="invalid-feedback">Kho là bắt buộc</div>
                            </div>
                        </div>

                        <!-- Row 4: Mức tối thiểu -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Mức Tối Thiểu</label>
                                <input type="number" class="form-control" id="addMat_MucToiThieu" min="0" step="0.01" placeholder="Mặc định: 5">
                                <div class="form-text text-muted small">Nếu để trống, hệ thống tự đặt = 5</div>
                            </div>
                        </div>

                        <!-- Row 5: Mô tả (full width) -->
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Mô Tả</label>
                            <textarea class="form-control" id="addMat_MoTa" rows="3" placeholder="Mô tả chi tiết vật tư..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button type="button" class="btn btn-light rounded-3 fw-bold" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i>Hủy
                    </button>
                    <button type="button" class="btn btn-primary rounded-3 fw-bold px-4" id="btnSaveNewMaterial" onclick="saveNewMaterial()">
                        <i class="bi bi-check-lg me-1"></i>Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══ EXPORT EXCEL MODAL ═══ -->
    <div class="modal fade" id="exportExcelModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0 px-4 pt-4">
                    <div>
                        <h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-excel text-success me-2"></i>Xuất Excel</h5>
                        <p class="text-muted small mb-0">Chọn kho cần xuất báo cáo kiểm kê</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body px-4 py-3">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-primary fw-bold" onclick="toggleAllExportKho(true)">
                            <i class="bi bi-check-all me-1"></i>Chọn tất cả
                        </button>
                        <button class="btn btn-sm btn-outline-secondary fw-bold" onclick="toggleAllExportKho(false)">
                            <i class="bi bi-x-lg me-1"></i>Bỏ chọn tất cả
                        </button>
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary ms-auto align-self-center px-3 py-2" id="exportKhoCount">0 kho</span>
                    </div>
                    <div id="exportKhoList" style="max-height: 260px; overflow-y: auto;"></div>

                    <!-- Export mode selection — only visible when >1 kho selected -->
                    <div id="exportModeSection" style="display:none" class="mt-3 pt-3 border-top">
                        <p class="fw-bold small text-muted mb-2"><i class="bi bi-gear me-1"></i>Cách xuất file:</p>
                        <div class="d-flex flex-column gap-2">
                            <label class="d-flex align-items-center gap-2 p-2 rounded-3 border" style="cursor:pointer">
                                <input type="radio" name="exportMode" value="per-file" class="form-check-input" checked style="min-width:18px;min-height:18px">
                                <div>
                                    <span class="fw-semibold"><i class="bi bi-files me-1"></i>Mỗi kho một file</span>
                                    <div class="text-muted small">Mỗi kho tải về 1 file .xls riêng biệt</div>
                                </div>
                            </label>
                            <label class="d-flex align-items-center gap-2 p-2 rounded-3 border" style="cursor:pointer">
                                <input type="radio" name="exportMode" value="single-file" class="form-check-input" style="min-width:18px;min-height:18px">
                                <div>
                                    <span class="fw-semibold"><i class="bi bi-file-earmark-spreadsheet me-1"></i>Xuất chung một file</span>
                                    <div class="text-muted small">1 file duy nhất, mỗi kho là 1 sheet riêng</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button type="button" class="btn btn-light rounded-3 fw-bold" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i>Hủy
                    </button>
                    <button type="button" class="btn btn-success rounded-3 fw-bold px-4" id="btnExecuteExport" onclick="executeMultiKhoExport()" disabled>
                        <i class="bi bi-download me-1"></i>Xuất File Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('%c[Dashboard] JS loaded successfully', 'color: green; font-weight: bold');

        // ═══ NOTIFICATION SYSTEM ═══
        const _toastIcons = {
            success: 'bi-check-circle-fill',
            error:   'bi-exclamation-triangle-fill',
            warning: 'bi-exclamation-circle-fill'
        };

        function showToast(type, message, duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-custom toast-${type}`;
            toast.innerHTML = `
                <i class="bi ${_toastIcons[type] || _toastIcons.error} toast-icon"></i>
                <div class="toast-body">${message}</div>
                <button class="toast-close" onclick="dismissToast(this.parentElement)">&times;</button>`;
            container.appendChild(toast);
            const timer = setTimeout(() => dismissToast(toast), duration);
            toast._timer = timer;
        }

        function dismissToast(el) {
            if (!el || el.classList.contains('toast-hiding')) return;
            clearTimeout(el._timer);
            el.classList.add('toast-hiding');
            el.addEventListener('animationend', () => el.remove());
        }

        function showInlineError(inputId, message) {
            clearInlineError(inputId);
            const input = document.getElementById(inputId);
            if (!input) return;
            input.classList.add('is-invalid-custom');
            const err = document.createElement('div');
            err.className = 'inline-error';
            err.id = inputId + '_err';
            err.innerHTML = `<i class="bi bi-exclamation-circle"></i>${message}`;
            input.closest('.col-md-6, .col-md-3, .col-md-4, .mb-3, .position-relative, .input-group')?.parentElement?.appendChild(err)
                || input.parentElement.appendChild(err);
            input.addEventListener('input', function handler() {
                clearInlineError(inputId);
                input.removeEventListener('input', handler);
            }, { once: true });
        }

        function clearInlineError(inputId) {
            const input = document.getElementById(inputId);
            if (input) input.classList.remove('is-invalid-custom');
            document.getElementById(inputId + '_err')?.remove();
        }

        function showConfirm(title, message, onYes) {
            const backdrop = document.createElement('div');
            backdrop.className = 'confirm-modal-backdrop';
            backdrop.innerHTML = `
                <div class="confirm-modal-box">
                    <h6>${title}</h6>
                    <p>${message}</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-light rounded-3 fw-bold px-4" id="confirmNo">Hủy</button>
                        <button class="btn btn-danger rounded-3 fw-bold px-4" id="confirmYes">Đồng ý</button>
                    </div>
                </div>`;
            document.body.appendChild(backdrop);
            backdrop.querySelector('#confirmNo').onclick = () => backdrop.remove();
            backdrop.querySelector('#confirmYes').onclick = () => { backdrop.remove(); onYes(); };
            backdrop.addEventListener('click', (e) => { if (e.target === backdrop) backdrop.remove(); });
        }

        // GLOBAL STATE
        let currentWarehouseId = null;
        let currentAction = null;
        let draftTransactions = [];
        let allWarehouses = [];
        let allNhomVatLieu = [];
        let allDonViTinh = [];
        let stockData = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let _searchTimer = null;
        let _modalSearchTimer = null;

        // ── HELPER: Debounce wrapper ──
        function debounce(fn, timerId, delay = 300) {
            if (timerId === 'main') { clearTimeout(_searchTimer); _searchTimer = setTimeout(fn, delay); }
            else { clearTimeout(_modalSearchTimer); _modalSearchTimer = setTimeout(fn, delay); }
        }

        // ── HELPER: Remove Vietnamese diacritics for search ──
        function removeDiacritics(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D');
        }
        function searchMatch(text, query) {
            const t = removeDiacritics(text.toLowerCase());
            const q = removeDiacritics(query.toLowerCase());
            return t.includes(q);
        }

        // INITIALIZE
        document.addEventListener('DOMContentLoaded', async function () {
            await loadWarehouses();
            await loadNhomVatLieu();
            await loadDonViTinh();

            // Setup add material modal events
            const addModal = document.getElementById('addMaterialModal');
            addModal.addEventListener('show.bs.modal', populateAddMaterialDropdowns);
            addModal.addEventListener('hidden.bs.modal', resetAddMaterialForm);
            addModal.querySelectorAll('.form-control, .form-select').forEach(el => {
                el.addEventListener('input', () => el.classList.remove('is-invalid'));
                el.addEventListener('change', () => el.classList.remove('is-invalid'));
            });
        });

        // LOAD WAREHOUSES
        async function loadWarehouses() {
            try {
                const response = await fetch('/api/kho/danhsachkho');
                allWarehouses = await response.json();
                const selector = document.getElementById('warehouseSelector');
                const transferSelector = document.getElementById('transferToWarehouse');
                selector.innerHTML = '<option value="">-- Chọn Kho --</option>';
                transferSelector.innerHTML = '<option value="">-- Chọn kho đích --</option>';
                allWarehouses.forEach(wh => {
                    const prefix = wh.loaiKho === 'KHO_ME' ? '★ ' : '  └ ';
                    selector.innerHTML += `<option value="${wh.id}">${prefix}${wh.tenKho}</option>`;
                    transferSelector.innerHTML += `<option value="${wh.id}">${wh.tenKho}</option>`;
                });
            } catch (error) {
                console.error('Error loading warehouses:', error);
            }
        }

        // LOAD NHÓM VẬT LIỆU
        async function loadNhomVatLieu() {
            try {
                const response = await fetch('/api/kho/nhomvatlieu');
                allNhomVatLieu = await response.json();
            } catch (error) {
                console.error('Error loading nhom vat lieu:', error);
            }
        }

        // LOAD ĐƠN VỊ TÍNH
        async function loadDonViTinh() {
            try {
                const response = await fetch('/api/kho/donvitinh');
                allDonViTinh = await response.json();
            } catch (error) {
                console.error('Error loading don vi tinh:', error);
            }
        }

        // LOAD STOCK DATA
        async function loadStockData() {
            if (!currentWarehouseId) return;
            try {
                console.log('Loading stock data for warehouse ID:', currentWarehouseId);
                const response = await fetch(`/api/kho/tonkho?khoId=${currentWarehouseId}`);
                console.log('Response status:', response.status);
                
                const responseData = await response.json();
                console.log('Response data:', responseData);
                
                if (!response.ok) {
                    console.error('API Error:', responseData.message || 'Unknown error');
                    stockData = [];
                    renderTable();
                    return;
                }
                
                // Đảm bảo stockData là array
                if (Array.isArray(responseData)) {
                    stockData = responseData;
                } else {
                    console.error('Response is not an array:', responseData);
                    stockData = [];
                }
                
                console.log('Stock data loaded:', stockData.length, 'items');
                renderTable();
            } catch (error) {
                console.error('Error loading stock:', error);
                stockData = [];
                renderTable();
            }
        }

        // SWITCH WAREHOUSE
        async function switchWarehouse() {
            const selector = document.getElementById('warehouseSelector');
            currentWarehouseId = selector.value ? parseInt(selector.value) : null;
            if (currentWarehouseId) {
                await loadStockData();
                document.getElementById('selectedWarehouseName').textContent = selector.options[selector.selectedIndex].text.trim();
            } else {
                stockData = [];
                renderEmptyTable();
            }
        }

        // RENDER EMPTY TABLE
        function renderEmptyTable() {
            const tbody = document.getElementById('materialTableBody');
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-5">
                <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
                Vui lòng chọn kho để xem tồn kho
            </td></tr>`;
            document.getElementById('totalItems').textContent = '0';
            document.getElementById('totalStock').textContent = '0';
            document.getElementById('totalValue').textContent = '0 đ';
            document.getElementById('displayCount').textContent = '0';
            document.getElementById('pagination').innerHTML = '';
        }

        // RENDER TABLE
        function renderTable() {
            const tbody = document.getElementById('materialTableBody');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedData = stockData.slice(start, end);

            tbody.innerHTML = '';
            let totalStock = 0;
            let totalValue = 0;

            if (stockData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-5">
                    <i class="bi bi-box-seam fs-1 d-block mb-2 opacity-50"></i>
                    Không có dữ liệu tồn kho cho kho này
                </td></tr>`;
            } else {
                paginatedData.forEach((item, index) => {
                    const stock = item.soLuongTon || 0;
                    const khaDung = item.soLuongKhaDung ?? stock;
                    const donGia = item.donGia || 0;
                    const thanhTien = stock * donGia;
                    totalStock += stock;
                    totalValue += thanhTien;
                    const stt = start + index + 1;

                    const row = `<tr class="animate-fade-in">
                        <td class="ps-4 text-center text-muted">${stt}</td>
                        <td><span class="badge bg-secondary bg-opacity-10 text-dark px-2 py-1">${item.maVatLieu}</span></td>
                        <td>${item.tenVatLieu}</td>
                        <td><span class="text-muted">${item.donViTinh}</span></td>
                        <td class="text-end currency-num">${donGia.toLocaleString('vi-VN', {minimumFractionDigits: 2})}</td>
                        <td class="text-center"><span class="badge ${stock < 10 ? 'bg-danger' : 'bg-success'} rounded-pill px-3">${stock.toLocaleString('vi-VN')}</span></td>
                        <td class="text-center"><span class="badge ${khaDung < 10 ? 'bg-warning text-dark' : 'bg-info text-dark'} rounded-pill px-3">${khaDung.toLocaleString('vi-VN')}</span></td>
                        <td class="text-end pe-4 fw-bold currency-num">${thanhTien.toLocaleString('vi-VN')}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }

            // Total stats from all stock data (not just paginated)
            totalStock = stockData.reduce((sum, i) => sum + (i.soLuongTon || 0), 0);
            totalValue = stockData.reduce((sum, i) => {
                const qty = i.soLuongTon || 0;
                const price = i.donGia || 0;
                return sum + (qty * price);
            }, 0);

            document.getElementById('totalItems').textContent = stockData.length;
            document.getElementById('totalStock').textContent = totalStock.toLocaleString('vi-VN');
            document.getElementById('totalValue').textContent = totalValue.toLocaleString('vi-VN') + ' đ';
            document.getElementById('displayCount').textContent = stockData.length;
            renderPagination();
        }

        // PAGINATION
        function renderPagination() {
            const totalPages = Math.ceil(stockData.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                pagination.innerHTML += `<button class="btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-secondary'}" onclick="goToPage(${i})">${i}</button>`;
            }
        }

        function goToPage(page) {
            currentPage = page;
            renderTable();
        }

        // SEARCH MATERIAL (MAIN TABLE)
        function searchMaterial() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length === 0) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            const results = stockData.filter(m => 
                searchMatch(m.maVatLieu, query) || 
                searchMatch(m.tenVatLieu, query)
            );
            const dropdown = document.getElementById('searchResults');
            dropdown.innerHTML = '';
            if (results.length > 0) {
                results.slice(0, 5).forEach(mat => {
                    dropdown.innerHTML += `<div class="result-item" onclick="selectMaterialFromSearch(${mat.vatLieuId})">
                        <span><strong>${mat.maVatLieu}</strong> - ${mat.tenVatLieu}</span>
                        <span class="badge bg-${mat.soLuongTon < 10 ? 'danger' : 'success'}">${mat.soLuongTon}</span>
                    </div>`;
                });
                dropdown.style.display = 'block';
            } else {
                dropdown.innerHTML = '<div class="text-muted text-center p-3">Không tìm thấy vật tư</div>';
                dropdown.style.display = 'block';
            }
        }

        function selectMaterialFromSearch(id) {
            openActionModal(id);
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
        }

        // OPEN ACTION MODAL
        function openActionModal(materialId = null) {
            if (!currentWarehouseId) {
                showToast('warning', 'Vui lòng chọn kho trước khi thực hiện giao dịch!');
                return;
            }
            // Update warehouse name in modal header
            const selector = document.getElementById('warehouseSelector');
            const whName = selector.options[selector.selectedIndex]?.text?.trim() || '';
            document.getElementById('modalWarehouseName').textContent = whName;
            
            const modal = new bootstrap.Modal(document.getElementById('actionModal'));
            modal.show();
            if (materialId) {
                const mat = stockData.find(m => m.vatLieuId === materialId);
                if (mat) {
                    document.getElementById('materialSearch').value = `${mat.maVatLieu} - ${mat.tenVatLieu}`;
                    document.getElementById('materialSearch').dataset.materialId = materialId;
                    document.getElementById('selectedMaterialId').value = materialId;
                    // Lock material name — readonly after selection
                    document.getElementById('materialSearch').setAttribute('readonly', true);
                    // Auto-fill đơn giá from VatLieu.DonGia (via stockData)
                    document.getElementById('donGiaInput').value = (mat.donGia > 0) ? mat.donGia : 0;
                    // Enforce readonly based on current action type
                    applyDonGiaReadonly();
                }
            }
        }

        // ── HELPER: Lock/unlock đơn giá based on action type ──
        function applyDonGiaReadonly() {
            const donGiaInput = document.getElementById('donGiaInput');
            if (currentAction === 'NHAP') {
                // NHAP: cho phép sửa đơn giá
                donGiaInput.removeAttribute('readonly');
                donGiaInput.classList.remove('bg-light');
            } else {
                // XUAT / DIEUCHUYEN: khóa đơn giá = VatLieu.DonGia hiện tại
                const materialId = parseInt(document.getElementById('selectedMaterialId').value);
                if (materialId) {
                    const stockItem = stockData.find(s => s.vatLieuId === materialId);
                    if (stockItem && stockItem.donGia > 0) {
                        donGiaInput.value = stockItem.donGia;
                    }
                }
                donGiaInput.setAttribute('readonly', true);
                donGiaInput.classList.add('bg-light');
            }
        }

        // ── HELPER: Clear material selection to allow re-search ──
        function clearMaterialSelection() {
            const input = document.getElementById('materialSearch');
            // Clear previous selection
            input.dataset.materialId = '';
            document.getElementById('selectedMaterialId').value = '';
            input.value = '';
            document.getElementById('donGiaInput').value = '0';
            // Unlock for search
            input.removeAttribute('readonly');
            input.focus();
        }

        // SELECT ACTION
        function selectAction(action) {
            currentAction = action;
            document.querySelectorAll('.btn-action').forEach(btn => btn.classList.remove('active-import', 'active-export', 'active-transfer'));
            const btn = event.currentTarget;
            if (action === 'NHAP') btn.classList.add('active-import');
            else if (action === 'XUAT') btn.classList.add('active-export');
            else if (action === 'DIEUCHUYEN') btn.classList.add('active-transfer');

            const transferSection = document.getElementById('transferWarehouseSection');
            const nhapExtraFields = document.getElementById('nhapKhoExtraFields');
            
            if (action === 'DIEUCHUYEN') {
                transferSection.classList.remove('d-none');
                nhapExtraFields.classList.add('d-none');
            } else if (action === 'NHAP') {
                transferSection.classList.add('d-none');
                nhapExtraFields.classList.remove('d-none');
            } else {
                transferSection.classList.add('d-none');
                nhapExtraFields.classList.add('d-none');
            }
            
            // Enforce đơn giá readonly/editable based on action type
            applyDonGiaReadonly();
        }

        // SEARCH MATERIAL IN MODAL — uses stockData (TonKho-filtered by warehouse)
        function searchMaterialInModal() {
            const query = document.getElementById('materialSearch').value.trim();
            const results = stockData.filter(m => 
                searchMatch(m.maVatLieu, query) || 
                searchMatch(m.tenVatLieu, query)
            );
            const dropdown = document.getElementById('modalSearchResults');
            dropdown.innerHTML = '';
            if (query.length > 0 && results.length > 0) {
                results.slice(0, 5).forEach(mat => {
                    dropdown.innerHTML += `<div class="result-item" onclick="selectMaterialInModal(${mat.vatLieuId}, '${mat.maVatLieu}', '${mat.tenVatLieu.replace(/'/g, "\\'")}')">
                        <span><strong>${mat.maVatLieu}</strong> - ${mat.tenVatLieu}</span>
                        <span class="badge bg-${mat.soLuongTon < 10 ? 'danger' : 'success'}">${mat.soLuongTon} ${mat.donViTinh}</span>
                    </div>`;
                });
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function selectMaterialInModal(id, code, name) {
            document.getElementById('materialSearch').value = `${code} - ${name}`;
            document.getElementById('materialSearch').dataset.materialId = id;
            document.getElementById('selectedMaterialId').value = id;
            document.getElementById('modalSearchResults').style.display = 'none';
            
            // Lock material name — KHÔNG cho sửa tên vật tư
            document.getElementById('materialSearch').setAttribute('readonly', true);
            
            // Auto-fill đơn giá from VatLieu.DonGia (via stockData)
            const stockItem = stockData.find(s => s.vatLieuId === id);
            if (stockItem && stockItem.donGia > 0) {
                document.getElementById('donGiaInput').value = stockItem.donGia;
            } else {
                document.getElementById('donGiaInput').value = '0';
            }
            
            // Enforce readonly based on action type (XUAT/DIEUCHUYEN = locked)
            applyDonGiaReadonly();
        }

        // COMMIT ACTION
        function commitAction() {
            if (!currentAction) {
                showToast('warning', 'Vui lòng chọn loại giao dịch: NHẬP / XUẤT / ĐIỀU CHUYỂN');
                return;
            }
            const materialId = parseInt(document.getElementById('materialSearch').dataset.materialId || document.getElementById('selectedMaterialId').value);
            const quantity = parseFloat(document.getElementById('quantityInput').value);
            const donGia = parseFloat(document.getElementById('donGiaInput').value) || 0;
            const note = document.getElementById('noteInput').value;

            // Inline validation
            let hasErr = false;
            if (!materialId) {
                showInlineError('materialSearch', 'Vui lòng chọn vật tư');
                hasErr = true;
            }
            if (!quantity || quantity <= 0) {
                showInlineError('quantityInput', 'Số lượng phải lớn hơn 0');
                hasErr = true;
            }
            if (hasErr) return;

            let targetWarehouseId = null;
            if (currentAction === 'DIEUCHUYEN') {
                targetWarehouseId = parseInt(document.getElementById('transferToWarehouse').value);
                if (!targetWarehouseId) {
                    showInlineError('transferToWarehouse', 'Vui lòng chọn kho đích');
                    return;
                }
            }

            // Lấy thông tin bổ sung cho nhập kho
            let extraData = {};
            if (currentAction === 'NHAP') {
                extraData = {
                    soLo: document.getElementById('soLoInput').value || null,
                    ngaySanXuat: document.getElementById('ngaySanXuatInput').value || null,
                    ngayHetHan: document.getElementById('ngayHetHanInput').value || null,
                    nhaCungCap: document.getElementById('nhaCungCapInput').value || null
                };
            }

            const mat = stockData.find(m => m.vatLieuId === materialId);
            draftTransactions.push({
                vatLieuId: materialId,
                maVatLieu: mat ? mat.maVatLieu : '',
                tenVatLieu: mat ? mat.tenVatLieu : 'N/A',
                soLuong: quantity,
                donGia: donGia,
                thanhTien: quantity * donGia,
                loaiPhieu: currentAction,
                khoNhanId: targetWarehouseId,
                ghiChu: note,
                ...extraData
            });

            renderDraftList();
            resetInputFields();
        }
        
        function resetInputFields() {
            const materialInput = document.getElementById('materialSearch');
            materialInput.value = '';
            materialInput.dataset.materialId = '';
            materialInput.setAttribute('readonly', true); // Reset to clickable-only state
            document.getElementById('selectedMaterialId').value = '';
            document.getElementById('quantityInput').value = '1';
            document.getElementById('donGiaInput').value = '0';
            document.getElementById('donGiaInput').removeAttribute('readonly');
            document.getElementById('donGiaInput').classList.remove('bg-light');
            document.getElementById('noteInput').value = '';
            document.getElementById('soLoInput').value = '';
            document.getElementById('ngaySanXuatInput').value = '';
            document.getElementById('ngayHetHanInput').value = '';
            document.getElementById('nhaCungCapInput').value = '';
            // Re-apply readonly based on current action
            applyDonGiaReadonly();
        }

        // RENDER DRAFT LIST
        function renderDraftList() {
            const tbody = document.getElementById('sessionListBody');
            tbody.innerHTML = '';
            let totalQty = 0;
            let totalAmount = 0;
            
            draftTransactions.forEach((item, index) => {
                const actionColor = item.loaiPhieu === 'NHAP' ? 'success' : item.loaiPhieu === 'XUAT' ? 'danger' : 'warning';
                const thanhTien = item.soLuong * (item.donGia || 0);
                totalQty += item.soLuong;
                totalAmount += thanhTien;
                
                const row = `<tr>
                    <td class="ps-3">
                        <div class="fw-bold">${item.tenVatLieu}</div>
                        <small class="text-muted">${item.maVatLieu}</small>
                    </td>
                    <td class="text-center"><span class="badge bg-${actionColor}">${item.loaiPhieu}</span></td>
                    <td class="text-end fw-bold">${item.soLuong.toLocaleString('vi-VN')}</td>
                    <td class="text-end">${(item.donGia || 0).toLocaleString('vi-VN')}</td>
                    <td class="text-end fw-bold text-primary">${thanhTien.toLocaleString('vi-VN')}</td>
                    <td class="text-end pe-3"><button class="btn btn-sm btn-outline-danger" onclick="removeDraft(${index})"><i class="bi bi-trash"></i></button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
            
            document.getElementById('draftCount').textContent = `${draftTransactions.length} mục`;
            const emptyEl = document.getElementById('emptyState');
            emptyEl.style.display = draftTransactions.length === 0 ? 'flex' : 'none';
            
            // Cập nhật summary
            const summaryDiv = document.getElementById('draftSummary');
            if (draftTransactions.length > 0) {
                summaryDiv.classList.remove('d-none');
                document.getElementById('summaryCount').textContent = draftTransactions.length;
                document.getElementById('summaryQty').textContent = totalQty.toLocaleString('vi-VN');
                document.getElementById('summaryTotal').textContent = totalAmount.toLocaleString('vi-VN') + ' đ';
            } else {
                summaryDiv.classList.add('d-none');
            }
        }

        function removeDraft(index) {
            draftTransactions.splice(index, 1);
            renderDraftList();
        }

        // FINISH AND SAVE
        async function finishAndSave() {
            if (draftTransactions.length === 0) {
                showToast('warning', 'Chưa có giao dịch nào trong danh sách dự thảo!');
                return;
            }

            try {
                // Build items array for API
                const items = draftTransactions.map(t => ({
                    vatLieuId: t.vatLieuId,
                    loaiPhieu: t.loaiPhieu,
                    soLuong: t.soLuong,
                    donGia: t.donGia || 0,
                    khoNhanId: t.khoNhanId || null,
                    soLo: t.soLo || null,
                    ngaySanXuat: t.ngaySanXuat || null,
                    ngayHetHan: t.ngayHetHan || null,
                    nhaCungCap: t.nhaCungCap || null,
                    ghiChu: t.ghiChu || null
                }));

                const payload = {
                    khoId: currentWarehouseId,
                    ghiChu: draftTransactions[0]?.ghiChu || null,
                    items: items
                };

                const response = await fetch('/api/kho/giaodich', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showToast('success', result.message || 'Giao dịch hoàn tất thành công!');
                    draftTransactions = [];
                    renderDraftList();
                    await loadStockData();
                    bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
                } else {
                    let errorMsg = result.message || 'Có lỗi xảy ra';
                    if (result.errors && result.errors.length > 0) {
                        errorMsg += '<br>' + result.errors.join('<br>');
                    }
                    showToast('error', errorMsg, 6000);
                }
            } catch (error) {
                console.error('Error saving transaction:', error);
                showToast('error', 'Không thể kết nối đến máy chủ. Vui lòng thử lại!');
            }
        }

        // ═══ NHẬT KÝ (AUDIT LOG) ═══════════════════════════
        var nkCurrentPage = 1;

        async function showHistory() {
            // Populate kho filter dropdown from allWarehouses
            var khoSelect = document.getElementById('nkFilterKho');
            if (khoSelect.options.length <= 1) {
                allWarehouses.forEach(function(wh) {
                    var opt = document.createElement('option');
                    opt.value = wh.id;
                    opt.textContent = wh.tenKho;
                    khoSelect.appendChild(opt);
                });
            }
            await loadNhatKy(1);
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        }

        function resetNhatKyFilter() {
            document.getElementById('nkFilterTuNgay').value = '';
            document.getElementById('nkFilterDenNgay').value = '';
            document.getElementById('nkFilterKho').value = '';
            document.getElementById('nkFilterLoai').value = '';
            document.getElementById('nkFilterSearch').value = '';
            loadNhatKy(1);
        }

        async function loadNhatKy(page) {
            nkCurrentPage = page || 1;
            var params = new URLSearchParams();
            params.set('page', nkCurrentPage);
            params.set('pageSize', 20);

            var tuNgay = document.getElementById('nkFilterTuNgay').value;
            var denNgay = document.getElementById('nkFilterDenNgay').value;
            var khoId = document.getElementById('nkFilterKho').value;
            var loai = document.getElementById('nkFilterLoai').value;
            var search = document.getElementById('nkFilterSearch').value.trim();

            if (tuNgay) params.set('tuNgay', tuNgay);
            if (denNgay) params.set('denNgay', denNgay);
            if (khoId) params.set('khoId', khoId);
            if (loai) params.set('loaiThayDoi', loai);
            if (search) params.set('searchVatLieu', search);

            try {
                var response = await fetch('/api/kho/lichsu?' + params.toString());
                if (!response.ok) throw new Error('HTTP ' + response.status);
                var data = await response.json();

                var tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';

                var emptyMsg = document.getElementById('emptyHistoryMsg');
                var pagArea = document.getElementById('nkPaginationArea');

                if (!data.items || data.items.length === 0) {
                    emptyMsg.classList.remove('d-none');
                    pagArea.style.display = 'none';
                    return;
                }

                emptyMsg.classList.add('d-none');

                data.items.forEach(function(p) {
                    var loaiColor = 'secondary';
                    var loaiLabel = p.loaiPhieu;
                    if (p.loaiPhieu === 'NHAP_KHO') { loaiColor = 'success'; loaiLabel = 'Nhập kho'; }
                    else if (p.loaiPhieu === 'XUAT_KHO') { loaiColor = 'danger'; loaiLabel = 'Xuất kho'; }
                    else if (p.loaiPhieu === 'CHUYEN_KHO') { loaiColor = 'warning'; loaiLabel = 'Chuyển kho'; }

                    var khoText = p.tenKhoNguon || '';
                    if (p.loaiPhieu === 'CHUYEN_KHO' && p.tenKhoNhap) {
                        khoText = p.tenKhoNguon + ' → ' + p.tenKhoNhap;
                    }

                    var ngay = p.ngayThucHien ? new Date(p.ngayThucHien) : null;
                    var ngayStr = ngay ? (ngay.getDate().toString().padStart(2, '0') + '/' + (ngay.getMonth() + 1).toString().padStart(2, '0') + '/' + ngay.getFullYear() + ' ' + ngay.getHours().toString().padStart(2, '0') + ':' + ngay.getMinutes().toString().padStart(2, '0')) : '';

                    var row = '<tr style="cursor:pointer" onclick="showTransactionDetail(' + p.phieuId + ')">';
                    row += '<td class="ps-3 fw-semibold text-primary">' + escapeHtml(p.maPhieu) + '<\/td>';
                    row += '<td><span class="badge bg-' + loaiColor + '">' + loaiLabel + '<\/span><\/td>';
                    row += '<td>' + escapeHtml(khoText) + '<\/td>';
                    row += '<td>' + escapeHtml(p.nguoiThucHien) + '<\/td>';
                    row += '<td>' + ngayStr + '<\/td>';
                    row += '<td class="text-center"><span class="badge bg-light text-dark">' + p.tongSoVatTu + '<\/span><\/td>';
                    row += '<td class="text-end pe-3"><button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();showTransactionDetail(' + p.phieuId + ')"><i class="bi bi-eye me-1"><\/i>Xem<\/button><\/td>';
                    row += '<\/tr>';
                    tbody.innerHTML += row;
                });

                // Pagination
                renderNhatKyPagination(data);
            } catch (error) {
                console.error('Error loading history:', error);
                showToast('error', 'Không thể tải nhật ký: ' + error.message);
            }
        }

        function renderNhatKyPagination(data) {
            var pagArea = document.getElementById('nkPaginationArea');
            var pagInfo = document.getElementById('nkPaginationInfo');
            var pagList = document.getElementById('nkPaginationList');

            if (data.totalPages <= 1) {
                pagArea.style.display = 'none';
                pagInfo.textContent = 'Tổng: ' + data.totalCount + ' phiếu';
                if (data.totalCount > 0) {
                    pagArea.style.display = '';
                    pagArea.classList.remove('d-none');
                }
                pagList.innerHTML = '';
                return;
            }

            pagArea.style.display = '';
            pagArea.classList.remove('d-none');

            var start = (data.page - 1) * data.pageSize + 1;
            var end = Math.min(data.page * data.pageSize, data.totalCount);
            pagInfo.textContent = 'Hiển thị ' + start + '-' + end + ' / ' + data.totalCount + ' phiếu';

            pagList.innerHTML = '';

            // Previous
            var prevLi = document.createElement('li');
            prevLi.className = 'page-item' + (data.page <= 1 ? ' disabled' : '');
            prevLi.innerHTML = '<a class="page-link" href="#" onclick="event.preventDefault();loadNhatKy(' + (data.page - 1) + ')">‹<\/a>';
            pagList.appendChild(prevLi);

            // Page numbers (show max 5 around current)
            var startPage = Math.max(1, data.page - 2);
            var endPage = Math.min(data.totalPages, startPage + 4);
            if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

            for (var i = startPage; i <= endPage; i++) {
                var li = document.createElement('li');
                li.className = 'page-item' + (i === data.page ? ' active' : '');
                li.innerHTML = '<a class="page-link" href="#" onclick="event.preventDefault();loadNhatKy(' + i + ')">' + i + '<\/a>';
                pagList.appendChild(li);
            }

            // Next
            var nextLi = document.createElement('li');
            nextLi.className = 'page-item' + (data.page >= data.totalPages ? ' disabled' : '');
            nextLi.innerHTML = '<a class="page-link" href="#" onclick="event.preventDefault();loadNhatKy(' + (data.page + 1) + ')">›<\/a>';
            pagList.appendChild(nextLi);
        }

        // SHOW TRANSACTION DETAIL
        async function showTransactionDetail(phieuId) {
            try {
                var response = await fetch('/api/kho/lichsu/' + phieuId);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                var data = await response.json();

                // Header
                var loaiColor = 'secondary';
                var loaiLabel = data.loaiPhieu;
                if (data.loaiPhieu === 'NHAP_KHO') { loaiColor = 'success'; loaiLabel = 'NHẬP KHO'; }
                else if (data.loaiPhieu === 'XUAT_KHO') { loaiColor = 'danger'; loaiLabel = 'XUẤT KHO'; }
                else if (data.loaiPhieu === 'CHUYEN_KHO') { loaiColor = 'warning'; loaiLabel = 'CHUYỂN KHO'; }

                var headerEl = document.getElementById('detailModalHeader');
                headerEl.className = 'modal-header border-0 px-4 pt-3 pb-2';
                if (loaiColor === 'success') headerEl.style.background = '#d1e7dd';
                else if (loaiColor === 'danger') headerEl.style.background = '#f8d7da';
                else if (loaiColor === 'warning') headerEl.style.background = '#fff3cd';
                else headerEl.style.background = '#e2e3e5';

                document.getElementById('detailModalTitle').textContent = data.maPhieu + ' — ' + loaiLabel;

                var ngay = data.ngayThucHien ? new Date(data.ngayThucHien) : null;
                var ngayStr = ngay ? (ngay.getDate().toString().padStart(2, '0') + '/' + (ngay.getMonth() + 1).toString().padStart(2, '0') + '/' + ngay.getFullYear() + ' ' + ngay.getHours().toString().padStart(2, '0') + ':' + ngay.getMinutes().toString().padStart(2, '0')) : '';
                document.getElementById('detailModalSubtitle').textContent = ngayStr + ' | ' + data.nguoiThucHien;

                // Info cards
                var cardsHtml = '';
                var khoText = data.tenKhoNguon || '';
                if (data.loaiPhieu === 'CHUYEN_KHO' && data.tenKhoNhap) khoText += ' → ' + data.tenKhoNhap;
                cardsHtml += '<div class="col-auto"><span class="badge bg-light text-dark border px-3 py-2"><i class="bi bi-building me-1"><\/i>' + escapeHtml(khoText) + '<\/span><\/div>';
                cardsHtml += '<div class="col-auto"><span class="badge bg-light text-dark border px-3 py-2"><i class="bi bi-person me-1"><\/i>' + escapeHtml(data.nguoiThucHien) + '<\/span><\/div>';
                cardsHtml += '<div class="col-auto"><span class="badge bg-' + loaiColor + ' px-3 py-2">' + loaiLabel + '<\/span><\/div>';
                if (data.ghiChu) cardsHtml += '<div class="col-auto"><span class="badge bg-light text-dark border px-3 py-2"><i class="bi bi-chat-text me-1"><\/i>' + escapeHtml(data.ghiChu) + '<\/span><\/div>';
                document.getElementById('detailInfoCards').innerHTML = cardsHtml;

                // Detail table
                var tbody = document.getElementById('detailTableBody');
                tbody.innerHTML = '';

                if (!data.chiTiet || data.chiTiet.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Không có chi tiết<\/td><\/tr>';
                } else {
                    data.chiTiet.forEach(function(item) {
                        var actionColor = 'secondary';
                        var actionLabel = item.loaiThayDoi;
                        if (item.loaiThayDoi === 'NHAP') { actionColor = 'success'; actionLabel = 'NHẬP'; }
                        else if (item.loaiThayDoi === 'XUAT') { actionColor = 'danger'; actionLabel = 'XUẤT'; }
                        else if (item.loaiThayDoi === 'CHUYEN_DI') { actionColor = 'warning'; actionLabel = 'CHUYỂN ĐI'; }
                        else if (item.loaiThayDoi === 'CHUYEN_DEN') { actionColor = 'info'; actionLabel = 'CHUYỂN ĐẾN'; }

                        var changeSign = item.soLuongThayDoi >= 0 ? '+' : '';
                        var changeColor = item.soLuongThayDoi >= 0 ? 'text-success' : 'text-danger';

                        var khoInfo = escapeHtml(item.tenKho);
                        if (item.tenKhoLienQuan) {
                            if (item.loaiThayDoi === 'CHUYEN_DI') khoInfo += ' → ' + escapeHtml(item.tenKhoLienQuan);
                            else if (item.loaiThayDoi === 'CHUYEN_DEN') khoInfo = escapeHtml(item.tenKhoLienQuan) + ' → ' + escapeHtml(item.tenKho);
                        }

                        var tg = item.thoiGian ? new Date(item.thoiGian) : null;
                        var tgStr = tg ? (tg.getHours().toString().padStart(2, '0') + ':' + tg.getMinutes().toString().padStart(2, '0') + ':' + tg.getSeconds().toString().padStart(2, '0')) : '';

                        var row = '<tr>';
                        row += '<td class="ps-3"><div class="fw-semibold">' + escapeHtml(item.tenVatLieu) + '<\/div><small class="text-muted">' + escapeHtml(item.maVatLieu) + ' | ' + escapeHtml(item.donViTinh) + '<\/small><\/td>';
                        row += '<td>' + khoInfo + '<\/td>';
                        row += '<td class="text-center"><span class="badge bg-' + actionColor + '">' + actionLabel + '<\/span><\/td>';
                        row += '<td class="text-end">' + formatNumber(item.soLuongTruoc) + '<\/td>';
                        row += '<td class="text-end fw-bold ' + changeColor + '">' + changeSign + formatNumber(item.soLuongThayDoi) + '<\/td>';
                        row += '<td class="text-end fw-bold">' + formatNumber(item.soLuongSau) + '<\/td>';
                        row += '<td>' + tgStr + '<\/td>';
                        row += '<td class="text-end pe-3">' + escapeHtml(item.nguoiThucHien) + '<\/td>';
                        row += '<\/tr>';
                        tbody.innerHTML += row;
                    });
                }

                new bootstrap.Modal(document.getElementById('transactionDetailModal')).show();
            } catch (error) {
                console.error('Error loading detail:', error);
                showToast('error', 'Không thể tải chi tiết phiếu: ' + error.message);
            }
        }

        function formatNumber(n) {
            if (n == null || isNaN(n)) return '0';
            return Number(n).toLocaleString('vi-VN', { maximumFractionDigits: 3 });
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // ═══ EXPORT EXCEL — Multi-warehouse, exact HTML-blob format ═══
        // Uses HTML-table-to-Blob approach with Excel xmlns directives
        // 17 columns, Excel formulas, mso-number-format — EXACT format from spec
        // Supports: per-file export (1 kho = 1 .xls) OR multi-sheet export (all kho = 1 .xls)

        function exportReport() {
            // Open modal — populate warehouse checkboxes from allWarehouses
            var container = document.getElementById('exportKhoList');
            container.innerHTML = '';
            allWarehouses.forEach(function(wh) {
                var prefix = wh.loaiKho === 'KHO_ME' ? '<i class="bi bi-star-fill text-warning me-1" style="font-size:0.7rem"><\/i>' : '';
                var checked = (currentWarehouseId && wh.id === currentWarehouseId) ? 'checked' : '';
                container.innerHTML += '<label class="d-flex align-items-center gap-3 p-2 rounded-3 border mb-2" style="cursor:pointer">' +
                    '<input type="checkbox" class="form-check-input export-kho-cb" value="' + wh.id + '" ' + checked + ' onchange="updateExportKhoCount()" style="min-width:20px;min-height:20px">' +
                    '<div>' + prefix + '<span class="fw-semibold">' + wh.tenKho + '<\/span>' +
                    '<div class="text-muted small">' + (wh.loaiKho === 'KHO_ME' ? 'Kho M\u1eb9' : 'Kho Con') + '<\/div><\/div><\/label>';
            });
            updateExportKhoCount();
            new bootstrap.Modal(document.getElementById('exportExcelModal')).show();
        }

        function toggleAllExportKho(state) {
            document.querySelectorAll('.export-kho-cb').forEach(function(cb) { cb.checked = state; });
            updateExportKhoCount();
        }

        function updateExportKhoCount() {
            var count = document.querySelectorAll('.export-kho-cb:checked').length;
            document.getElementById('exportKhoCount').textContent = count + ' kho';
            document.getElementById('btnExecuteExport').disabled = (count === 0);
            // Show/hide export mode selection when multiple kho selected
            var modeSection = document.getElementById('exportModeSection');
            if (modeSection) {
                modeSection.style.display = (count > 1) ? 'block' : 'none';
            }
        }

        function buildExcelHtmlForKho(whName, khoData) {
            var date = new Date();
            var dateStr = 'Ng\u00e0y ' + date.getDate() + ' th\u00e1ng ' + (date.getMonth() + 1) + ' n\u0103m ' + date.getFullYear();

            var startRow = 7;
            var endRow = startRow + khoData.length - 1;

            // Build header via string concat — avoids literal closing tags in script block
            var h = '';
            h += '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">';
            h += '<head><meta charset="UTF-8">';
            h += '<style>';
            h += 'table{border-collapse:collapse;width:100%;font-family:"Times New Roman",Times,serif;font-size:11pt}';
            h += 'td,th{border:1px solid #000;padding:5px;text-align:center;vertical-align:middle}';
            h += '.text-left{text-align:left}.text-right{text-align:right}';
            h += '.header-title{font-size:20px;font-weight:bold;text-transform:uppercase;border:none!important}';
            h += '.no-border{border:none!important}.bold{font-weight:bold}';

            h += 'tr.gray-row th:nth-child(-n+17), tr.gray-row td:nth-child(-n+17){background-color:#f0f0f0;font-weight:bold;}';

            h += '<' + '/style>';
            h += '<' + '/head>';
            h += '<body><table>';

            h += '<colgroup>';
            h += '<col style="width:35px"/>';
            h += '<col style="width:80px"/>';
            h += '<col style="width:250px"/>';
            h += '<col style="width:50px"/>';
            h += '<col style="width:100px"/>';
            h += '<col style="width:60px"/>';
            h += '<col style="width:120px"/>';
            h += '<col style="width:60px"/>';
            h += '<col style="width:120px"/>';
            h += '<col style="width:60px"/>';
            h += '<col style="width:120px"/>';
            h += '<col style="width:60px"/>';
            h += '<col style="width:120px"/>';
            h += '<col style="width:80px"/>';
            h += '<col style="width:90px"/>';
            h += '<col style="width:90px"/>';
            h += '<col style="width:80px"/>';
            h += '</colgroup>';

            h += '<tr><td colspan="17" class="header-title no-border" style="text-align:center;font-weight:bold;font-size:25px">BI\u00caN B\u1ea2N KI\u1ec2M K\u00ca V\u1eacT T\u01af TH\u00c0NH PH\u1ea8M</td></tr>';
            h += '<tr><td colspan="17" class="no-border" style="text-align:center;font-weight:bold;">Th\u1eddi \u0111i\u1ec3m ki\u1ec3m k\u00ea: ' + dateStr + ' - Kho: ' + whName + '</td></tr>';
            h += '<tr><td colspan="17" class="no-border"></td></tr>';

            h += '<tr class="gray-row">';
            h += '<th rowspan="2">STT</th><th rowspan="2">M\u00e3 VT</th><th rowspan="2" style="width:250px">T\u00ean nh\u00e3n hi\u1ec7u, quy c\u00e1ch</th><th rowspan="2">\u0110VT</th><th rowspan="2">\u0110\u01a1n gi\u00e1</th>';
            h += '<th colspan="2">Theo s\u1ed5 k\u1ebf to\u00e1n</th><th colspan="2">Ki\u1ec3m k\u00ea</th><th colspan="2">Th\u1eeba</th><th colspan="2">Thi\u1ebfu</th>';
            h += '<th rowspan="2">C\u00f2n t\u1ed1t 100%</th><th rowspan="2">K\u00e9m ph\u1ea9m ch\u1ea5t</th><th rowspan="2">M\u1ea5t ph\u1ea9m ch\u1ea5t</th><th rowspan="2">Ghi ch\u00fa</th>';
            h += '</tr>';

            h += '<tr class="gray-row">';
            h += '<th>SL</th><th>Th\u00e0nh ti\u1ec1n</th><th>SL</th><th>Th\u00e0nh ti\u1ec1n</th><th>SL</th><th>Th\u00e0nh ti\u1ec1n</th><th>SL</th><th>Th\u00e0nh ti\u1ec1n</th>';
            h += '</tr>';

            /* HÀNG 6 */
            h += '<tr style="font-style:italic;text-align:center">';
            h += '<td>A</td><td>B</td><td>C</td><td>D</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td><td>11</td><td>12</td><td>13</td>';
            h += '</tr>';

            // DATA ROWS
            khoData.forEach(function(item, index) {
                var stock = item.soLuongTon || 0;
                var price = item.donGia || 0;
                var cr = startRow + index;
                h += '<tr>';
                h += '<td>' + (index + 1) + '<' + '/td>';
                h += '<td class="text-left" style="mso-number-format:\'\\@@\'">'; h += item.maVatLieu; h += '<' + '/td>';
                h += '<td class="text-left">' + item.tenVatLieu + '<' + '/td>';
                h += '<td>' + item.donViTinh + '<' + '/td>';
                h += '<td class="text-right" x:num="' + price + '" style="mso-number-format:\'#,##0.00\'">' + price + '<' + '/td>';
                h += '<td class="text-center" x:num="' + stock + '">' + stock + '<' + '/td>';
                h += '<td class="text-right" x:num x:fmla="=F' + cr + '*E' + cr + '" style="mso-number-format:\'#,##0.00\'"><' + '/td>';
                h += '<td><' + '/td>';
                h += '<td class="text-right" x:num x:fmla="=H' + cr + '*E' + cr + '" style="mso-number-format:\'#,##0.00\'"><' + '/td>';
                h += '<td><' + '/td>';
                h += '<td class="text-right" x:num x:fmla="=J' + cr + '*E' + cr + '" style="mso-number-format:\'#,##0.00\'"><' + '/td>';
                h += '<td><' + '/td>';
                h += '<td class="text-right" x:num x:fmla="=L' + cr + '*E' + cr + '" style="mso-number-format:\'#,##0.00\'"><' + '/td>';
                h += '<td><' + '/td><td><' + '/td><td><' + '/td><td><' + '/td>';
                h += '<' + '/tr>';
            });

            // TOTAL ROW
            h += '<tr style="font-weight:bold">';
            h += '<td colspan="5" class="text-center">C\u1ed8NG<' + '/td>';
            h += '<td><' + '/td>';
            h += '<td x:num x:fmla="=SUM(G' + startRow + ':G' + endRow + ')" style="mso-number-format:\'\\#\\,\\#\\#0\';text-align:right"><' + '/td>';
            h += '<td><' + '/td>';
            h += '<td x:num x:fmla="=SUM(I' + startRow + ':I' + endRow + ')" style="mso-number-format:\'\\#\\,\\#\\#0\';text-align:right"><' + '/td>';
            h += '<td><' + '/td>';
            h += '<td x:num x:fmla="=SUM(K' + startRow + ':K' + endRow + ')" style="mso-number-format:\'\\#\\,\\#\\#0\';text-align:right"><' + '/td>';
            h += '<td><' + '/td>';
            h += '<td x:num x:fmla="=SUM(M' + startRow + ':M' + endRow + ')" style="mso-number-format:\'\\#\\,\\#\\#0\';text-align:right"><' + '/td>';
            h += '<td><' + '/td><td><' + '/td><td><' + '/td><td><' + '/td>';
            h += '<' + '/tr>';

            h += '<' + '/table><' + '/body><' + '/html>';
            return h;
        }

        // ═══ MHTML Multi-sheet — wraps buildExcelHtmlForKho output in MHTML container ═══
        // Each sheet is 100% identical to per-file export (reuses same buildExcelHtmlForKho)
        // MHTML format: Excel reads each MIME part as a separate worksheet
        function buildMhtmlWorkbook(sheets) {
            // sheets = [{name: 'Kho A', html: '...'}, {name: 'Kho B', html: '...'}, ...]
            var boundary = '----=_NextPart_VMS';
            var nl = '\r\n';

            // Build sheet definitions for ExcelWorkbook XML
            var sheetDefs = '';
            for (var si = 0; si < sheets.length; si++) {
                sheetDefs += '<x:ExcelWorksheet>';
                sheetDefs += '<x:Name>' + sheets[si].name.replace(/&/g, '&amp;').replace(/</g, '&lt;') + '<' + '/x:Name>';
                sheetDefs += '<x:WorksheetSource HRef="sheet' + (si + 1) + '.htm"/>';
                sheetDefs += '<' + '/x:ExcelWorksheet>';
            }

            // Main index document — tells Excel which sheets exist
            var mainDoc = '';
            mainDoc += '<html xmlns:o="urn:schemas-microsoft-com:office:office"';
            mainDoc += ' xmlns:x="urn:schemas-microsoft-com:office:excel"';
            mainDoc += ' xmlns="http://www.w3.org/TR/REC-html40">';
            mainDoc += '<head>';
            mainDoc += '<xml>';
            mainDoc += '<x:ExcelWorkbook>';
            mainDoc += '<x:ExcelWorksheets>';
            mainDoc += sheetDefs;
            mainDoc += '<' + '/x:ExcelWorksheets>';
            mainDoc += '<x:FullCalculationOnLoad/>';
            mainDoc += '<x:ActiveSheet>0<' + '/x:ActiveSheet>';
            mainDoc += '<x:ProtectStructure>False<' + '/x:ProtectStructure>';
            mainDoc += '<x:ProtectWindows>False<' + '/x:ProtectWindows>';
            mainDoc += '<' + '/x:ExcelWorkbook>';
            mainDoc += '<' + '/xml>';
            mainDoc += '<' + '/head>';
            mainDoc += '<body>';
            mainDoc += '<' + '/body>';
            mainDoc += '<' + '/html>';

            // Assemble MHTML
            var mhtml = '';
            mhtml += 'MIME-Version: 1.0' + nl;
            mhtml += 'X-Document-Type: Workbook' + nl;
            mhtml += 'Content-Type: multipart/related; boundary="' + boundary + '"' + nl;
            mhtml += nl;

            // Part 0: Main index document
            mhtml += '--' + boundary + nl;
            mhtml += 'Content-Location: file:///C:/WorkFiles/Book.htm' + nl;
            mhtml += 'Content-Type: text/html; charset="utf-8"' + nl;
            mhtml += nl;
            mhtml += mainDoc + nl;

            // Part 1..N: Each sheet = EXACT output of buildExcelHtmlForKho (100% identical)
            for (var si = 0; si < sheets.length; si++) {
                mhtml += '--' + boundary + nl;
                mhtml += 'Content-Location: file:///C:/WorkFiles/sheet' + (si + 1) + '.htm' + nl;
                mhtml += 'Content-Type: text/html; charset="utf-8"' + nl;
                mhtml += nl;
                mhtml += sheets[si].html + nl;
            }

            mhtml += '--' + boundary + '--';
            return mhtml;
        }


        async function executeMultiKhoExport() {
            var selectedIds = [];
            document.querySelectorAll('.export-kho-cb:checked').forEach(function(cb) {
                selectedIds.push(parseInt(cb.value));
            });
            if (selectedIds.length === 0) {
                showToast('warning', 'Vui l\u00f2ng ch\u1ecdn \u00edt nh\u1ea5t 1 kho!');
                return;
            }

            // Determine export mode
            var exportMode = 'per-file'; // default
            if (selectedIds.length > 1) {
                var modeRadio = document.querySelector('input[name="exportMode"]:checked');
                if (modeRadio) exportMode = modeRadio.value;
            }

            // Disable button + show loading
            var btn = document.getElementById('btnExecuteExport');
            var originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"><\/span>\u0110ang t\u1ea1o file...';

            try {
                if (exportMode === 'single-file') {
                    // ══ MODE 2: All kho in 1 file, each kho = 1 worksheet ══
                    // Uses MHTML format: each sheet = EXACT output of buildExcelHtmlForKho (100% identical)
                    var sheetsArray = [];
                    var exportedCount = 0;

                    for (var i = 0; i < selectedIds.length; i++) {
                        var khoId = selectedIds[i];
                        var wh = allWarehouses.find(function(w) { return w.id === khoId; });
                        var whName = wh ? wh.tenKho : ('Kho ' + khoId);

                        var khoData = [];
                        try {
                            var resp = await fetch('/api/kho/tonkho?khoId=' + khoId);
                            if (resp.ok) {
                                var json = await resp.json();
                                if (Array.isArray(json)) khoData = json;
                            }
                        } catch (e) {
                            console.error('Failed to load kho ' + khoId, e);
                        }

                        if (khoData.length === 0) continue;

                        // Reuse EXACT same buildExcelHtmlForKho — 100% identical to per-file export
                        var sheetHtml = buildExcelHtmlForKho(whName, khoData);
                        var safeName = whName.replace(/[\[\]\*\?\/\\:]/g, '').substring(0, 31);
                        sheetsArray.push({ name: safeName, html: sheetHtml });
                        exportedCount++;
                    }

                    if (exportedCount > 0) {
                        var mhtmlContent = buildMhtmlWorkbook(sheetsArray);
                        var blob = new Blob([mhtmlContent], { type: 'application/vnd.ms-excel' });
                        var link = document.createElement('a');
                        var url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        var d = new Date();
                        var dd = String(d.getDate()).padStart(2, '0');
                        var mm = String(d.getMonth() + 1).padStart(2, '0');
                        var yyyy = d.getFullYear();
                        link.setAttribute('download', 'TongHop_KiemKe_' + dd + '-' + mm + '-' + yyyy + '.xls');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        showToast('success', '\u0110\u00e3 xu\u1ea5t ' + exportedCount + ' kho v\u00e0o 1 file Excel!');
                    } else {
                        showToast('warning', 'Kh\u00f4ng c\u00f3 d\u1eef li\u1ec7u t\u1ed3n kho \u0111\u1ec3 xu\u1ea5t!');
                    }

                } else {
                    // ══ MODE 1: Each kho = 1 separate .xls file (original logic) ══
                    var exportedCount = 0;

                    for (var i = 0; i < selectedIds.length; i++) {
                        var khoId = selectedIds[i];
                        var wh = allWarehouses.find(function(w) { return w.id === khoId; });
                        var whName = wh ? wh.tenKho : ('Kho ' + khoId);

                        var khoData = [];
                        try {
                            var resp = await fetch('/api/kho/tonkho?khoId=' + khoId);
                            if (resp.ok) {
                                var json = await resp.json();
                                if (Array.isArray(json)) khoData = json;
                            }
                        } catch (e) {
                            console.error('Failed to load kho ' + khoId, e);
                        }

                        if (khoData.length === 0) continue;

                        // Build EXACT HTML-blob format (17 columns, Excel formulas, mso-number-format)
                        var h = buildExcelHtmlForKho(whName, khoData);

                        var blob = new Blob([h], { type: 'application/vnd.ms-excel' });
                        var link = document.createElement('a');
                        var url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', 'BienBanKiemKe_' + khoId + '_' + new Date().toISOString().slice(0, 10) + '.xls');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        exportedCount++;

                        // Small delay between downloads so browser doesn't block them
                        if (i < selectedIds.length - 1) {
                            await new Promise(function(resolve) { setTimeout(resolve, 500); });
                        }
                    }

                    if (exportedCount > 0) {
                        showToast('success', '\u0110\u00e3 xu\u1ea5t ' + exportedCount + ' kho ra file Excel!');
                    } else {
                        showToast('warning', 'Kh\u00f4ng c\u00f3 d\u1eef li\u1ec7u t\u1ed3n kho \u0111\u1ec3 xu\u1ea5t!');
                    }
                }

                // Close modal
                var modalEl = document.getElementById('exportExcelModal');
                var modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
            } catch (err) {
                console.error('Export error:', err);
                showToast('error', 'L\u1ed7i khi xu\u1ea5t Excel: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }
        // ─── ADD NEW MATERIAL ──────────────────────────────
        function populateAddMaterialDropdowns() {
            // NhomVatLieu dropdown — uses .ten (from DropdownItemDto)
            const nhomSelect = document.getElementById('addMat_NhomVatLieu');
            nhomSelect.innerHTML = '<option value="">-- Chọn nhóm --</option>';
            allNhomVatLieu.forEach(n => {
                nhomSelect.innerHTML += `<option value="${n.id}">${n.ten}</option>`;
            });

            // DonViTinh dropdown — uses .ten (from DropdownItemDto)
            const dvtSelect = document.getElementById('addMat_DonViTinh');
            dvtSelect.innerHTML = '<option value="">-- Chọn ĐVT --</option>';
            allDonViTinh.forEach(d => {
                dvtSelect.innerHTML += `<option value="${d.id}">${d.ten}</option>`;
            });

            // Kho dropdown — pre-select current warehouse
            const khoSelect = document.getElementById('addMat_KhoId');
            khoSelect.innerHTML = '<option value="">-- Chọn kho --</option>';
            allWarehouses.forEach(wh => {
                const selected = (currentWarehouseId && wh.id === currentWarehouseId) ? 'selected' : '';
                khoSelect.innerHTML += `<option value="${wh.id}" ${selected}>${wh.tenKho}</option>`;
            });
        }

        function resetAddMaterialForm() {
            const form = document.getElementById('formThemVatTu');
            if (form) form.reset();
            const donGiaEl = document.getElementById('addMat_DonGia');
            if (donGiaEl) donGiaEl.value = '0';
            const alertEl = document.getElementById('addMatAlert');
            if (alertEl) alertEl.innerHTML = '';
            document.querySelectorAll('#addMaterialModal .is-invalid').forEach(el => el.classList.remove('is-invalid'));
        }

        async function saveNewMaterial() {
            const btn = document.getElementById('btnSaveNewMaterial');
            const alertContainer = document.getElementById('addMatAlert');

            // ── Client-side validation ─────────────────────────
            let isValid = true;
            const validations = [
                { id: 'addMat_MaVatTu',      check: v => v.trim() !== '' },
                { id: 'addMat_TenVatTu',      check: v => v.trim() !== '' },
                { id: 'addMat_NhomVatLieu',   check: v => v !== '' },
                { id: 'addMat_DonViTinh',     check: v => v !== '' },
                { id: 'addMat_DonGia',        check: v => v !== '' && parseFloat(v) >= 0 },
                { id: 'addMat_KhoId',         check: v => v !== '' },
            ];
            validations.forEach(f => {
                const el = document.getElementById(f.id);
                if (!f.check(el.value)) { el.classList.add('is-invalid'); isValid = false; }
                else { el.classList.remove('is-invalid'); }
            });
            if (!isValid) return;

            // ── Disable button ─────────────────────────────────
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';

            const mucVal = document.getElementById('addMat_MucToiThieu').value;

            const payload = {
                maVatLieu:     document.getElementById('addMat_MaVatTu').value.trim(),
                tenVatLieu:    document.getElementById('addMat_TenVatTu').value.trim(),
                nhomVatLieuId: parseInt(document.getElementById('addMat_NhomVatLieu').value),
                donViTinhId:   parseInt(document.getElementById('addMat_DonViTinh').value),
                donGia:        parseFloat(document.getElementById('addMat_DonGia').value) || 0,
                khoId:         parseInt(document.getElementById('addMat_KhoId').value),
                moTa:          document.getElementById('addMat_MoTa').value.trim() || null,
                mucToiThieu:   mucVal ? parseFloat(mucVal) : null
            };

            try {
                const response = await fetch('/api/kho/themvattu', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alertContainer.innerHTML = `<div class="alert alert-success alert-dismissible rounded-3 mb-3" role="alert">
                        <i class="bi bi-check-circle-fill me-2"></i><strong>${result.message}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;
                    document.getElementById('formThemVatTu').reset();
                    document.getElementById('addMat_DonGia').value = '0';

                    // Reload stock data
                    if (currentWarehouseId) await loadStockData();

                    // Close modal after delay
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('addMaterialModal'))?.hide();
                    }, 1500);
                } else {
                    let errorHtml = '';
                    if (result.errors && result.errors.length > 0) {
                        errorHtml = '<ul class="mb-0 mt-1 ps-3 small">';
                        result.errors.forEach(e => errorHtml += `<li>${e}</li>`);
                        errorHtml += '</ul>';
                    }
                    alertContainer.innerHTML = `<div class="alert alert-danger alert-dismissible rounded-3 mb-3" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i><strong>${result.message || 'Có lỗi xảy ra.'}</strong>
                        ${errorHtml}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;
                }
            } catch (err) {
                alertContainer.innerHTML = `<div class="alert alert-danger rounded-3 mb-3">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Không thể kết nối đến máy chủ.
                </div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        // LOGOUT
        function logout() {
            showConfirm('Đăng xuất', 'Bạn có chắc chắn muốn đăng xuất không?', () => {
                window.location.href = '/Login/Logout';
            });
        }
    </script>
</body>

</html>